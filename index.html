<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>D.E.A.N.O | Darts Education & Analytics for Next-level Outcomes</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="D.E.A.N.O - Darts Education & Analytics for Next-level Outcomes. The ultimate darts scoring app with practice modes, checkout charts, and detailed statistics.">
    <meta name="theme-color" content="#ff6b35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="D.E.A.N.O">
    <meta name="application-name" content="D.E.A.N.O">
    <meta name="msapplication-TileColor" content="#0a0a0f">
    <meta name="msapplication-config" content="none">

    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --theme-primary: #ff6b35;
            --theme-secondary: #00d4aa;
            --theme-accent: #ffd93d;
            
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-glass: rgba(255, 255, 255, 0.03);
            --bg-glass-hover: rgba(255, 255, 255, 0.06);
            --border-glass: rgba(255, 255, 255, 0.08);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.4);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --glow-color: rgba(255, 107, 53, 0.3);
            
            --dart-black: #1a1a1a;
            --dart-cream: #f5f0dc;
            --dart-red: #e23636;
            --dart-green: #208b3a;
            
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
        }

        [data-theme="light"] {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e4e6eb;
            --bg-glass: rgba(0, 0, 0, 0.02);
            --bg-glass-hover: rgba(0, 0, 0, 0.05);
            --border-glass: rgba(0, 0, 0, 0.1);
            --text-primary: #1a1a2e;
            --text-secondary: rgba(26, 26, 46, 0.7);
            --text-muted: rgba(26, 26, 46, 0.4);
            --shadow-color: rgba(0, 0, 0, 0.08);
        }

        [data-color="ember"] { --theme-primary: #ff6b35; --theme-secondary: #00d4aa; --theme-accent: #ffd93d; }
        [data-color="ocean"] { --theme-primary: #0096c7; --theme-secondary: #48cae4; --theme-accent: #90e0ef; }
        [data-color="forest"] { --theme-primary: #40916c; --theme-secondary: #74c69d; --theme-accent: #b7e4c7; }
        [data-color="royal"] { --theme-primary: #7b2cbf; --theme-secondary: #c77dff; --theme-accent: #e0aaff; }
        [data-color="crimson"] { --theme-primary: #dc2f02; --theme-secondary: #f48c06; --theme-accent: #ffba08; }
        [data-color="mono"] { --theme-primary: #6c757d; --theme-secondary: #adb5bd; --theme-accent: #dee2e6; }
        [data-color="custom"] { 
            --theme-primary: var(--custom-primary, #ff6b35); 
            --theme-secondary: var(--custom-secondary, #00d4aa); 
            --theme-accent: #ffd93d; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { font-size: 16px; height: 100%; }
        
        body {
            font-family: 'Space Grotesk', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100%;
            overflow-x: hidden;
            line-height: 1.4;
            transition: background var(--transition-base), color var(--transition-base);
        }

        .app-bg {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
        }

        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.12;
            animation: float 25s ease-in-out infinite;
        }

        .bg-orb-1 { width: 60vmax; height: 60vmax; top: -30%; left: -20%; background: var(--theme-primary); }
        .bg-orb-2 { width: 50vmax; height: 50vmax; bottom: -20%; right: -20%; background: var(--theme-secondary); animation-delay: -12s; }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(3%, 3%) scale(1.05); }
        }

        .glass {
            background: var(--bg-glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-glass);
        }

        .glass-solid {
            background: var(--bg-secondary);
            border: 1px solid var(--border-glass);
            box-shadow: 0 2px 12px var(--shadow-color);
        }

        .app {
            width: 100%;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        /* Tablet */
        @media (min-width: 768px) {
            .app {
                max-width: 100%;
            }
            
            .screen-content {
                max-width: 700px;
                margin: 0 auto;
                width: 100%;
            }

            .home-hero {
                padding: var(--space-xl) var(--space-lg);
            }

            .hero-title {
                font-size: 3rem;
            }

            .home-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .home-card.featured {
                grid-column: span 4;
            }

            .home-card {
                padding: var(--space-lg);
            }

            .card-icon {
                font-size: 2rem;
            }

            .card-title {
                font-size: 1.2rem;
            }
        }

        /* Desktop */
        @media (min-width: 1024px) {
            .screen-content {
                max-width: 900px;
            }

            .hero-title {
                font-size: 3.5rem;
            }

            .home-grid {
                gap: var(--space-md);
            }

            .home-card.featured {
                grid-column: span 2;
                flex-direction: row;
                align-items: center;
                gap: var(--space-md);
            }

            .checkout-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .stat-card.featured {
                grid-column: span 2;
            }
        }

        /* Large Desktop */
        @media (min-width: 1400px) {
            .screen-content {
                max-width: 1100px;
            }

            .home-grid {
                grid-template-columns: repeat(5, 1fr);
            }

            .home-card.featured {
                grid-column: span 3;
            }

            .checkout-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-sm) var(--space-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        @media (min-width: 768px) {
            .header {
                padding: var(--space-md) var(--space-lg);
            }

            .logo-icon {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .logo-text {
                font-size: 1.5rem;
            }

            .icon-btn {
                width: 44px;
                height: 44px;
                font-size: 20px;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .logo-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.25rem;
            letter-spacing: 2px;
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: var(--space-xs);
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            border: none;
            background: var(--bg-glass);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            font-size: 16px;
        }

        .icon-btn:hover, .icon-btn:active {
            background: var(--bg-glass-hover);
            color: var(--text-primary);
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-md) var(--space-sm);
            overflow-x: auto;
            scrollbar-width: none;
        }

        .nav::-webkit-scrollbar { display: none; }

        @media (min-width: 768px) {
            .nav {
                justify-content: center;
                gap: var(--space-sm);
                padding: var(--space-sm) var(--space-lg);
            }

            .nav-btn {
                flex: 0 0 auto;
                min-width: 100px;
                padding: var(--space-sm) var(--space-md);
                font-size: 0.8rem;
            }

            .nav-btn span:first-child {
                font-size: 1.25rem;
            }
        }

        @media (min-width: 1024px) {
            .nav-btn {
                min-width: 120px;
                padding: var(--space-sm) var(--space-lg);
            }
        }

        .nav-btn {
            flex: 1;
            min-width: 0;
            padding: var(--space-sm) var(--space-sm);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-glass);
            background: var(--bg-glass);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .nav-btn span:first-child { font-size: 1rem; }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
            border-color: transparent;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .screen {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .screen.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .screen-content {
            flex: 1;
            padding: 0 var(--space-md) var(--space-md);
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        @media (min-width: 768px) {
            .screen-content {
                padding: 0 var(--space-lg) var(--space-lg);
                gap: var(--space-lg);
            }
        }

        @media (min-width: 1024px) {
            .screen-content {
                padding: 0 var(--space-xl) var(--space-xl);
            }
        }

        /* ===== HOME ===== */
        .home-hero {
            text-align: center;
            padding: var(--space-xl) var(--space-md);
        }

        .hero-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            letter-spacing: 4px;
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-sub { color: var(--text-secondary); font-size: 0.9rem; }

        .home-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
        }

        .home-card {
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .home-card:hover, .home-card:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow-color);
        }

        .home-card.featured {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(255,107,53,0.15), rgba(0,212,170,0.15));
            border: 1px solid var(--theme-primary);
        }

        .card-icon { font-size: 1.5rem; }
        .card-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 1px; }
        .card-desc { font-size: 0.7rem; color: var(--text-muted); }

        /* ===== GAME SCREEN ===== */
        .game-layout {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .score-bar {
            display: flex;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-glass);
        }

        .player-card {
            flex: 1;
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            text-align: center;
            transition: all var(--transition-fast);
            position: relative;
        }

        .player-card.active {
            background: linear-gradient(135deg, rgba(255,107,53,0.2), rgba(0,212,170,0.1));
            box-shadow: 0 0 0 2px var(--theme-primary);
        }

        .player-card.active::after {
            content: 'â–¼';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--theme-primary);
            font-size: 8px;
        }

        /* Player-specific colors using gradient theme colors */
        .player-card.player-0.active {
            box-shadow: 0 0 0 2px var(--theme-primary);
        }
        .player-card.player-0.active::after {
            color: var(--theme-primary);
        }
        .player-card.player-0.active .player-score-main {
            color: var(--theme-primary);
        }

        .player-card.player-1.active {
            box-shadow: 0 0 0 2px var(--theme-secondary);
        }
        .player-card.player-1.active::after {
            color: var(--theme-secondary);
        }
        .player-card.player-1.active .player-score-main {
            color: var(--theme-secondary);
        }

        /* For 3+ players, alternate between primary and secondary */
        .player-card.player-2.active {
            box-shadow: 0 0 0 2px var(--theme-primary);
        }
        .player-card.player-2.active::after {
            color: var(--theme-primary);
        }
        .player-card.player-2.active .player-score-main {
            color: var(--theme-primary);
        }

        .player-card.player-3.active {
            box-shadow: 0 0 0 2px var(--theme-secondary);
        }
        .player-card.player-3.active::after {
            color: var(--theme-secondary);
        }
        .player-card.player-3.active .player-score-main {
            color: var(--theme-secondary);
        }

        .player-name {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-score-main {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.75rem;
            line-height: 1;
            color: var(--text-primary);
        }

        .player-card.active .player-score-main {
            color: var(--theme-primary);
        }

        .player-avg {
            font-size: 0.55rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .player-legs {
            font-size: 0.55rem;
            color: var(--theme-secondary);
            font-weight: 600;
        }

        @media (min-width: 768px) {
            .player-card {
                padding: var(--space-md);
            }

            .player-name {
                font-size: 0.7rem;
            }

            .player-avg {
                font-size: 0.65rem;
            }

            .player-legs {
                font-size: 0.65rem;
            }
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xs) var(--space-md);
            font-size: 0.65rem;
            color: var(--text-muted);
            background: var(--bg-tertiary);
        }

        .game-badge {
            padding: 2px 8px;
            background: var(--theme-primary);
            color: white;
            border-radius: var(--radius-sm);
            font-weight: 600;
        }

        .turn-display {
            padding: var(--space-sm) var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-md);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-glass);
        }

        .darts-thrown {
            display: flex;
            gap: var(--space-xs);
        }

        .dart-slot {
            width: 48px;
            height: 36px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            border: 2px dashed var(--border-glass);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            transition: all var(--transition-fast);
        }

        .dart-slot.filled {
            border-style: solid;
            border-color: var(--theme-primary);
            color: var(--text-primary);
            background: var(--bg-glass);
        }

        .dart-slot.current {
            border-color: var(--theme-secondary);
            animation: pulse 1.5s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 212, 170, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(0, 212, 170, 0); }
        }

        .turn-total {
            margin-left: auto;
            text-align: right;
        }

        .turn-total-label {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .turn-total-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            line-height: 1;
            color: var(--theme-primary);
        }

        .checkout-hint {
            padding: var(--space-xs) var(--space-md);
            background: linear-gradient(90deg, rgba(255,217,61,0.1), transparent);
            border-left: 3px solid var(--theme-accent);
            font-size: 0.7rem;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .checkout-hint.hidden { display: none; }

        .checkout-row {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .checkout-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            min-width: 50px;
        }

        .checkout-path {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--theme-accent);
        }

        .checkout-path.continue {
            color: var(--theme-secondary);
        }

        .checkout-alt {
            font-size: 0.6rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .input-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            background: var(--bg-primary);
        }

        .input-tabs {
            display: flex;
            padding: var(--space-xs);
            gap: var(--space-xs);
            background: var(--bg-secondary);
        }

        .input-tab {
            flex: 1;
            padding: var(--space-xs) var(--space-sm);
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-tab.active {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        @media (min-width: 768px) {
            .input-tabs {
                justify-content: center;
                gap: var(--space-sm);
            }

            .input-tab {
                flex: 0 0 auto;
                min-width: 80px;
                padding: var(--space-sm) var(--space-md);
                font-size: 0.75rem;
            }
        }

        .input-panel {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow-y: auto;
            padding: var(--space-sm);
        }

        .input-panel.active {
            display: flex;
        }

        /* Dartboard */
        .dartboard-wrap {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-xs);
            min-height: 260px;
            position: relative;
        }

        @media (min-width: 768px) {
            .dartboard-wrap {
                min-height: 320px;
                padding: var(--space-md);
            }
        }

        .dartboard-container {
            width: 100%;
            max-width: 300px;
            aspect-ratio: 1;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .dartboard-svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 4px 16px rgba(0,0,0,0.4));
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .dartboard-segment {
            cursor: pointer;
            transition: filter 0.1s ease;
        }

        .dartboard-segment:hover {
            filter: brightness(1.2);
        }

        .dartboard-segment:active {
            filter: brightness(1.4);
        }

        .dartboard-number {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 17px;
            fill: var(--dart-cream);
            pointer-events: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .fullscreen-btn {
            position: absolute;
            top: var(--space-sm);
            right: var(--space-sm);
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            border: none;
            background: var(--bg-glass);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            z-index: 10;
            transition: all var(--transition-fast);
        }

        .fullscreen-btn:hover {
            background: var(--bg-glass-hover);
            color: var(--text-primary);
        }

        /* Add fullscreen button to action bar as well */
        .action-bar .fullscreen-btn-bar {
            width: 44px;
            flex-shrink: 0;
            padding: var(--space-sm);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-bar .fullscreen-btn-bar:hover {
            background: var(--bg-glass-hover);
        }

        /* Darts Input */
        .darts-input {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .multiplier-bar {
            display: flex;
            gap: var(--space-xs);
        }

        .mult-btn {
            flex: 1;
            padding: var(--space-sm);
            border: 2px solid var(--border-glass);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .mult-btn.active {
            border-color: var(--theme-primary);
            background: rgba(255,107,53,0.15);
            color: var(--theme-primary);
        }

        .darts-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-xs);
        }

        .dart-btn {
            aspect-ratio: 1.2;
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            color: var(--text-primary);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .dart-btn:hover, .dart-btn:active {
            background: var(--bg-glass-hover);
            transform: scale(1.02);
        }

        .dart-btn.special {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
            border: none;
        }

        .dart-btn.miss {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        @media (min-width: 768px) {
            .darts-input {
                max-width: 450px;
                margin: 0 auto;
                width: 100%;
            }

            .dart-btn {
                font-size: 1.25rem;
            }
        }

        /* Quick Input */
        .quick-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-xs);
        }

        @media (min-width: 768px) {
            .quick-grid {
                max-width: 450px;
                margin: 0 auto;
                gap: var(--space-sm);
            }

            .quick-btn {
                padding: var(--space-md);
                font-size: 1rem;
            }
        }

        .quick-btn {
            padding: var(--space-md) var(--space-sm);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .quick-btn:hover, .quick-btn:active {
            background: var(--bg-glass-hover);
        }

        .quick-btn.highlight {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
            border: none;
        }

        .quick-btn.ton {
            background: rgba(0, 212, 170, 0.2);
            border-color: var(--theme-secondary);
        }

        .quick-btn.miss {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        /* Numpad */
        .numpad-wrap {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            max-width: 280px;
            margin: 0 auto;
            width: 100%;
        }

        .numpad-display {
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.75rem;
            font-weight: 600;
            min-height: 52px;
        }

        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-xs);
        }

        .num-btn {
            aspect-ratio: 1.4;
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            color: var(--text-primary);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .num-btn:hover, .num-btn:active {
            background: var(--bg-glass-hover);
        }

        .num-btn.action {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
            border: none;
        }

        .num-btn.secondary {
            background: var(--bg-tertiary);
            font-size: 1rem;
        }

        @media (min-width: 768px) {
            .numpad-wrap {
                max-width: 320px;
            }

            .numpad-display {
                font-size: 2rem;
            }

            .num-btn {
                font-size: 1.6rem;
            }
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-glass);
        }

        .action-btn {
            flex: 1;
            padding: var(--space-sm) var(--space-md);
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
        }

        .action-btn.secondary {
            background: var(--bg-glass);
            color: var(--text-secondary);
            border: 1px solid var(--border-glass);
        }

        .action-btn.danger {
            background: rgba(230, 57, 70, 0.1);
            color: #e63946;
            border: 1px solid rgba(230, 57, 70, 0.3);
        }

        @media (min-width: 768px) {
            .action-bar {
                padding: var(--space-md);
                gap: var(--space-sm);
            }

            .action-btn {
                padding: var(--space-md) var(--space-lg);
                font-size: 0.85rem;
            }
        }

        /* ===== FULLSCREEN MODE ===== */
        /* ===== FULLSCREEN GAME MODE ===== */
        .fullscreen-overlay {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: var(--bg-primary);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        /* Practice mode styling */
        .fullscreen-overlay.practice-mode.active {
            display: flex;
        }

        /* Game over must appear above fullscreen */
        .game-over-modal.open {
            z-index: 3000;
        }

        .fs-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: var(--space-xs) var(--space-sm);
            gap: var(--space-xs);
            flex-shrink: 0;
        }

        .fs-player-panel {
            flex: 1;
            max-width: 150px;
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-glass);
            border-radius: var(--radius-md);
            border: 2px solid transparent;
            transition: all var(--transition-fast);
        }

        .fs-player-panel.active {
            border-color: var(--theme-primary);
            background: linear-gradient(135deg, rgba(255,107,53,0.15), rgba(0,212,170,0.05));
        }

        /* Player 0 (left) uses primary color */
        .fs-player-panel.player-0.active {
            border-color: var(--theme-primary);
        }
        .fs-player-panel.player-0.active .fs-player-score {
            color: var(--theme-primary);
        }

        /* Player 1 (right) uses secondary color */
        .fs-player-panel.player-1.active {
            border-color: var(--theme-secondary);
        }
        .fs-player-panel.player-1.active .fs-player-score {
            color: var(--theme-secondary);
        }

        .fs-player-panel.right {
            text-align: right;
        }

        .fs-player-name {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fs-player-score {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.75rem;
            line-height: 1;
            color: var(--text-primary);
        }

        .fs-player-panel.active .fs-player-score {
            color: var(--theme-primary);
        }

        .fs-player-meta {
            display: flex;
            gap: var(--space-xs);
            margin-top: 2px;
            font-size: 0.5rem;
            color: var(--text-muted);
        }

        .fs-player-panel.right .fs-player-meta {
            justify-content: flex-end;
        }

        .fs-player-meta span {
            font-family: 'JetBrains Mono', monospace;
        }

        .fs-player-meta .val {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .fs-checkout {
            margin-top: 2px;
            padding: 3px 6px;
            background: rgba(255,217,61,0.15);
            border-radius: var(--radius-sm);
            font-size: 0.55rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--theme-accent);
            display: inline-block;
        }

        /* Practice Target Panel */
        .fs-practice-panel {
            flex: 1;
            max-width: 150px;
            padding: var(--space-xs) var(--space-sm);
            background: linear-gradient(135deg, rgba(255,107,53,0.2), rgba(0,212,170,0.2));
            border-radius: var(--radius-md);
            border: 2px solid var(--theme-primary);
            text-align: center;
        }

        .fs-practice-label {
            font-size: 0.5rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fs-practice-target {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.75rem;
            line-height: 1;
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .fs-practice-sub {
            font-size: 0.5rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Practice mode - hide QUICK/NUMPAD tabs */
        .fullscreen-overlay.practice-mode .fs-input-tabs [data-fstab="quick"],
        .fullscreen-overlay.practice-mode .fs-input-tabs [data-fstab="numpad"] {
            display: none;
        }

        .fs-center-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding-top: 2px;
        }

        .fs-match-info {
            font-size: 0.55rem;
            color: var(--text-muted);
        }

        .fs-close {
            width: 26px;
            height: 26px;
            border-radius: var(--radius-sm);
            border: none;
            background: var(--bg-glass);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        /* Main content area - fills available space */
        .fs-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
            width: 100%;
        }

        /* Input tabs */
        .fs-input-tabs {
            display: flex;
            padding: 0 var(--space-xs);
            gap: 2px;
            flex-shrink: 0;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .fs-input-tab {
            flex: 1;
            padding: var(--space-xs) var(--space-sm);
            border: none;
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-family: inherit;
            font-size: 0.6rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-transform: uppercase;
        }

        .fs-input-tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Input panels container */
        .fs-input-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            background: var(--bg-secondary);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            margin: 0 var(--space-xs);
            overflow: hidden;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            width: calc(100% - var(--space-xs) * 2);
        }

        .fs-input-panel {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
            padding: var(--space-xs);
        }

        .fs-input-panel.active {
            display: flex;
        }

        /* Board panel - keep as is */
        .fs-board-panel {
            justify-content: center;
            align-items: center;
        }

        .fs-board-panel .dartboard-container {
            width: 100%;
            max-width: min(calc(100vh - 320px), calc(100vw - 32px), 500px);
            aspect-ratio: 1;
            flex-shrink: 0;
        }

        /* Darts panel - fill available space */
        .fs-darts-panel {
            padding: var(--space-sm);
            gap: var(--space-sm);
        }

        .fs-mult-bar {
            display: flex;
            gap: var(--space-sm);
            width: 100%;
            flex-shrink: 0;
        }

        .fs-mult-btn {
            flex: 1;
            padding: var(--space-sm);
            border: 2px solid var(--border-glass);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .fs-mult-btn:hover {
            background: var(--bg-glass-hover);
        }

        .fs-mult-btn.active {
            border-color: var(--theme-primary);
            background: rgba(255,107,53,0.15);
            color: var(--theme-primary);
        }

        .fs-darts-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: var(--space-sm);
            width: 100%;
        }

        .fs-dart-btn {
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            color: var(--text-primary);
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(1.1rem, 4vh, 1.8rem);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .fs-dart-btn:hover {
            background: var(--bg-glass-hover);
        }

        .fs-dart-btn.special {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
            border: none;
        }

        .fs-dart-btn.miss {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        /* Quick panel - fill available space */
        .fs-quick-panel {
            padding: var(--space-sm);
            gap: var(--space-sm);
        }

        .fs-quick-panel .hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            flex-shrink: 0;
        }

        .fs-quick-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: var(--space-sm);
            width: 100%;
        }

        .fs-quick-btn {
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: clamp(1rem, 4vh, 1.5rem);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .fs-quick-btn:hover {
            background: var(--bg-glass-hover);
        }

        .fs-quick-btn.highlight {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
            border: none;
        }

        .fs-quick-btn.ton {
            background: rgba(0, 212, 170, 0.2);
            border-color: var(--theme-secondary);
        }

        .fs-quick-btn.miss {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        /* Numpad panel - fill available space proportionally */
        .fs-numpad-panel {
            padding: var(--space-sm);
            gap: var(--space-sm);
            align-items: center;
        }

        .fs-numpad-panel .hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            flex-shrink: 0;
        }

        .fs-numpad-wrap {
            flex: 1;
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .fs-numpad-display {
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: clamp(1.75rem, 5vh, 2.75rem);
            font-weight: 600;
            flex-shrink: 0;
        }

        .fs-numpad-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: var(--space-sm);
        }

        .fs-num-btn {
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            color: var(--text-primary);
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(1.4rem, 5vh, 2.2rem);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .fs-num-btn:hover {
            background: var(--bg-glass-hover);
        }

        .fs-num-btn.action {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
            border: none;
        }

        .fs-num-btn.secondary {
            background: var(--bg-tertiary);
            font-size: clamp(1rem, 3vh, 1.4rem);
        }

        /* Bottom bar - turn info and actions */
        .fs-bottom {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            background: var(--bg-tertiary);
            width: 100%;
        }

        .fs-turn-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm);
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .fs-darts {
            display: flex;
            gap: var(--space-xs);
        }

        .fs-dart {
            width: 50px;
            height: 36px;
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            border: 2px dashed var(--border-glass);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .fs-dart.filled {
            border-style: solid;
            border-color: var(--theme-primary);
            color: var(--text-primary);
        }

        .fs-total {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.75rem;
            color: var(--theme-primary);
            min-width: 50px;
            text-align: center;
        }

        .fs-actions {
            display: flex;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm) var(--space-sm);
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .fs-actions .action-btn {
            padding: var(--space-sm);
            font-size: 0.7rem;
        }

        /* Responsive - scale up elements for larger screens */
        @media (min-height: 700px) {
            .fs-player-score {
                font-size: 2rem;
            }
            .fs-practice-target {
                font-size: 2rem;
            }
            .fs-dart {
                width: 52px;
                height: 38px;
                font-size: 0.8rem;
            }
            .fs-total {
                font-size: 1.85rem;
            }
            .fs-turn-bar {
                padding: var(--space-sm);
                gap: var(--space-md);
            }
            .fs-actions {
                gap: var(--space-xs);
                padding: var(--space-sm);
            }
            .fs-actions .action-btn {
                padding: var(--space-sm) var(--space-md);
                font-size: 0.75rem;
            }
        }

        @media (min-height: 800px) {
            .fs-header {
                padding: var(--space-sm);
            }
            .fs-player-panel {
                padding: var(--space-sm);
            }
            .fs-practice-panel {
                padding: var(--space-sm);
            }
            .fs-player-score {
                font-size: 2.25rem;
            }
            .fs-practice-target {
                font-size: 2.25rem;
            }
            .fs-player-meta {
                font-size: 0.55rem;
            }
            .fs-practice-label, .fs-practice-sub {
                font-size: 0.55rem;
            }
            .fs-dart {
                width: 56px;
                height: 42px;
                font-size: 0.85rem;
            }
            .fs-total {
                font-size: 2rem;
            }
        }

        @media (min-height: 900px) {
            .fs-player-score {
                font-size: 2.5rem;
            }
            .fs-practice-target {
                font-size: 2.5rem;
            }
            .fs-turn-bar {
                padding: var(--space-md);
            }
            .fs-actions {
                padding: var(--space-sm) var(--space-md);
            }
            .fs-actions .action-btn {
                padding: var(--space-md) var(--space-lg);
                font-size: 0.8rem;
            }
            .fs-dart {
                width: 60px;
                height: 46px;
                font-size: 0.9rem;
            }
            .fs-total {
                font-size: 2.25rem;
                min-width: 70px;
            }
        }

        /* Wider screens */
        @media (min-width: 500px) {
            .fs-player-panel {
                max-width: 160px;
            }
            .fs-practice-panel {
                max-width: 160px;
            }
            .fs-input-tab {
                font-size: 0.65rem;
                padding: var(--space-xs) var(--space-sm);
            }
        }

        @media (min-width: 700px) {
            .fs-header {
                padding: var(--space-sm) var(--space-lg);
            }
            .fs-player-panel {
                max-width: 180px;
                padding: var(--space-sm) var(--space-md);
            }
            .fs-practice-panel {
                max-width: 180px;
                padding: var(--space-sm) var(--space-md);
            }
            .fs-practice-target {
                font-size: 2rem;
            }
            .fs-practice-label, .fs-practice-sub {
                font-size: 0.55rem;
            }
            .fs-player-meta {
                font-size: 0.6rem;
            }
            .fs-input-tab {
                font-size: 0.7rem;
                padding: var(--space-sm);
            }
        }

        @media (min-width: 900px) {
            .fs-header {
                padding: var(--space-sm) var(--space-xl);
            }
            .fs-player-panel {
                max-width: 200px;
                padding: var(--space-md);
            }
            .fs-practice-panel {
                max-width: 200px;
                padding: var(--space-md);
            }
            .fs-practice-target {
                font-size: 2.5rem;
            }
            .fs-practice-label, .fs-practice-sub {
                font-size: 0.6rem;
            }
            .fs-player-score {
                font-size: 2.5rem;
            }
            .fs-player-meta {
                font-size: 0.65rem;
                gap: var(--space-md);
            }
            .fs-checkout {
                font-size: 0.7rem;
                padding: 4px 10px;
            }
            .fs-input-tab {
                font-size: 0.75rem;
            }
            .fs-board-panel .dartboard-container {
                max-width: min(calc(100vh - 280px), 550px);
            }
            .fs-actions {
                gap: var(--space-sm);
            }
        }

        /* Landscape mobile - compact everything */
        @media (max-height: 500px) and (orientation: landscape) {
            .fs-header {
                padding: 4px var(--space-xs);
            }
            .fs-player-panel {
                padding: 4px 8px;
                max-width: 120px;
            }
            .fs-practice-panel {
                padding: 4px 8px;
                max-width: 120px;
            }
            .fs-practice-target {
                font-size: 1.3rem;
            }
            .fs-practice-label, .fs-practice-sub {
                font-size: 0.45rem;
            }
            .fs-player-score {
                font-size: 1.3rem;
            }
            .fs-player-meta {
                display: none;
            }
            .fs-checkout {
                font-size: 0.5rem;
                padding: 2px 4px;
            }
            .fs-input-tabs {
                padding: 0 4px;
            }
            .fs-input-tab {
                font-size: 0.5rem;
                padding: 4px 6px;
            }
            .fs-input-area {
                margin: 0 4px;
            }
            .fs-input-panel {
                padding: 4px;
            }
            .fs-board-panel .dartboard-container {
                max-width: min(calc(100vh - 120px), calc(100vw - 280px));
            }
            .fs-darts-panel, .fs-quick-panel, .fs-numpad-panel {
                padding: 4px;
                gap: 4px;
            }
            .fs-mult-bar {
                gap: 3px;
            }
            .fs-mult-btn {
                padding: 4px 6px;
                font-size: 0.6rem;
            }
            .fs-darts-grid, .fs-quick-grid, .fs-numpad-grid {
                gap: 3px;
            }
            .fs-quick-panel .hint, .fs-numpad-panel .hint {
                display: none;
            }
            .fs-numpad-wrap {
                max-width: 280px;
            }
            .fs-numpad-display {
                padding: 6px 10px;
            }
            .fs-turn-bar {
                padding: 4px;
                gap: var(--space-xs);
            }
            .fs-dart {
                width: 38px;
                height: 28px;
                font-size: 0.6rem;
            }
            .fs-darts {
                gap: 3px;
            }
            .fs-total {
                font-size: 1.2rem;
                min-width: 32px;
            }
            .fs-actions {
                padding: 4px;
                gap: 3px;
            }
            .fs-actions .action-btn {
                padding: 6px 10px;
                font-size: 0.55rem;
            }
        }

        .fs-turn {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-lg);
            padding: var(--space-md);
            background: var(--bg-secondary);
        }

        .fs-darts {
            display: flex;
            gap: var(--space-sm);
        }

        .fs-dart {
            width: 60px;
            height: 48px;
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            border: 2px dashed var(--border-glass);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .fs-dart.filled {
            border-style: solid;
            border-color: var(--theme-primary);
            color: var(--text-primary);
        }

        .fs-total {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: var(--theme-primary);
        }

        .fs-actions {
            display: flex;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
        }

        /* ===== SETUP ===== */
        .setup-section {
            border-radius: var(--radius-lg);
            padding: var(--space-md);
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 1px;
            margin-bottom: var(--space-sm);
            color: var(--text-secondary);
        }

        .option-row {
            display: flex;
            gap: var(--space-xs);
        }

        .option-btn {
            flex: 1;
            padding: var(--space-sm);
            border: 2px solid var(--border-glass);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .option-btn.selected {
            border-color: var(--theme-primary);
            background: rgba(255,107,53,0.1);
            color: var(--theme-primary);
        }

        .players-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .player-row {
            display: flex;
            gap: var(--space-xs);
        }

        .player-row input {
            flex: 1;
            padding: var(--space-sm) var(--space-md);
            border: 2px solid var(--border-glass);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
        }

        .player-row input:focus {
            border-color: var(--theme-primary);
        }

        .player-row input::placeholder {
            color: var(--text-muted);
        }

        .remove-btn {
            width: 40px;
            border: none;
            border-radius: var(--radius-md);
            background: rgba(230, 57, 70, 0.1);
            color: #e63946;
            cursor: pointer;
            font-size: 1rem;
        }

        .add-btn {
            padding: var(--space-sm);
            border: 2px dashed var(--border-glass);
            border-radius: var(--radius-md);
            background: transparent;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .add-btn:hover {
            border-color: var(--theme-primary);
            color: var(--theme-primary);
        }

        .setup-actions {
            display: flex;
            gap: var(--space-sm);
            padding: var(--space-md);
            margin-top: auto;
        }

        /* Responsive setup */
        @media (min-width: 768px) {
            #screen-play .screen-content {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-md);
                align-items: start;
            }

            .setup-section {
                margin: 0;
            }

            .setup-actions {
                grid-column: span 2;
                justify-content: center;
            }

            .setup-actions .action-btn {
                max-width: 300px;
            }
        }

        /* ===== PRACTICE ===== */
        .practice-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .practice-card {
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .practice-card:hover, .practice-card:active {
            transform: translateX(4px);
        }

        .practice-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .practice-info { flex: 1; }
        .practice-title { font-family: 'Bebas Neue', sans-serif; font-size: 0.95rem; letter-spacing: 1px; }
        .practice-desc { font-size: 0.65rem; color: var(--text-muted); }
        .practice-arrow { color: var(--text-muted); }

        /* Responsive practice grid */
        @media (min-width: 768px) {
            .practice-list {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-md);
            }

            .practice-card {
                flex-direction: column;
                text-align: center;
                padding: var(--space-lg);
            }

            .practice-icon {
                width: 56px;
                height: 56px;
                font-size: 1.5rem;
            }

            .practice-arrow {
                display: none;
            }
        }

        @media (min-width: 1024px) {
            .practice-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Practice Game */
        .practice-header {
            padding: var(--space-md);
            background: var(--bg-secondary);
            text-align: center;
            border-bottom: 1px solid var(--border-glass);
        }

        .practice-game-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 2px;
        }

        .practice-target {
            padding: var(--space-lg);
            text-align: center;
        }

        .target-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: var(--space-xs);
        }

        .target-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3.5rem;
            line-height: 1;
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .target-sub {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }

        .practice-stats {
            display: flex;
            justify-content: center;
            gap: var(--space-lg);
            padding: var(--space-md);
            background: var(--bg-tertiary);
        }

        .practice-stat {
            text-align: center;
        }

        .practice-stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            color: var(--theme-primary);
        }

        .practice-stat-label {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Responsive practice game */
        @media (min-width: 768px) {
            #screen-practice-game .game-layout {
                max-width: 600px;
                margin: 0 auto;
            }

            .practice-target {
                padding: var(--space-xl);
            }

            .target-value {
                font-size: 5rem;
            }

            .practice-stats {
                gap: var(--space-xl);
            }

            .practice-stat-value {
                font-size: 2rem;
            }
        }

        /* ===== LEARN ===== */
        .checkout-chart {
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            max-height: 70vh;
            overflow-y: auto;
        }

        .checkout-section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.85rem;
            color: var(--theme-primary);
            margin: var(--space-md) 0 var(--space-sm);
            padding-bottom: var(--space-xs);
            border-bottom: 1px solid var(--border-glass);
        }

        .checkout-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 3px;
        }

        .checkout-item {
            display: flex;
            justify-content: space-between;
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-glass);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
        }

        .checkout-num {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--theme-primary);
            width: 28px;
        }

        .checkout-route {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            text-align: right;
            flex: 1;
        }

        /* Responsive checkout chart */
        @media (min-width: 768px) {
            .checkout-chart {
                padding: var(--space-lg);
            }

            .checkout-item {
                padding: var(--space-sm) var(--space-md);
            }

            .checkout-num {
                font-size: 0.85rem;
            }

            .checkout-route {
                font-size: 0.8rem;
            }
        }

        /* ===== STATS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
        }

        .stat-card {
            border-radius: var(--radius-md);
            padding: var(--space-md);
            text-align: center;
        }

        .stat-card.featured {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(255,107,53,0.1), rgba(0,212,170,0.1));
            border: 1px solid var(--theme-primary);
        }

        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--theme-primary);
        }

        .stat-card.featured .stat-value {
            font-size: 2.25rem;
        }

        .stat-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Responsive stats */
        @media (min-width: 768px) {
            .stats-grid {
                gap: var(--space-md);
            }

            .stat-card {
                padding: var(--space-lg);
            }

            .stat-value {
                font-size: 2rem;
            }

            .stat-card.featured .stat-value {
                font-size: 3rem;
            }

            .stat-label {
                font-size: 0.7rem;
            }
        }

        /* Match Stats Panel */
        .match-stats {
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-around;
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .match-stat {
            text-align: center;
        }

        .match-stat-val {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* ===== MODALS ===== */
        .modal {
            position: fixed;
            inset: 0;
            z-index: 1000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .modal.open { display: flex; }

        @media (min-width: 768px) {
            .modal {
                align-items: center;
            }

            .modal-content {
                max-width: 500px;
                border-radius: var(--radius-xl);
                margin: var(--space-md);
            }
        }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            width: 100%;
            max-width: 480px;
            max-height: 85vh;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            padding: var(--space-md);
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-handle {
            width: 40px;
            height: 4px;
            background: var(--text-muted);
            border-radius: 2px;
            margin: 0 auto var(--space-md);
        }

        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 2px;
            margin-bottom: var(--space-md);
        }

        .settings-group {
            margin-bottom: var(--space-md);
        }

        .settings-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: var(--space-xs);
        }

        .toggle-row {
            display: flex;
            gap: var(--space-xs);
        }

        .toggle-btn {
            flex: 1;
            padding: var(--space-sm);
            border: 2px solid var(--border-glass);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .toggle-btn.active {
            border-color: var(--theme-primary);
            color: var(--theme-primary);
            background: rgba(255,107,53,0.1);
        }

        .color-row {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }

        .color-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            border: 3px solid transparent;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .color-btn:hover { transform: scale(1.1); }
        .color-btn.active { border-color: var(--text-primary); }

        .color-ember { background: linear-gradient(135deg, #ff6b35, #00d4aa); }
        .color-ocean { background: linear-gradient(135deg, #0096c7, #48cae4); }
        .color-forest { background: linear-gradient(135deg, #40916c, #74c69d); }
        .color-royal { background: linear-gradient(135deg, #7b2cbf, #c77dff); }
        .color-crimson { background: linear-gradient(135deg, #dc2f02, #f48c06); }
        .color-mono { background: linear-gradient(135deg, #6c757d, #adb5bd); }
        .color-custom { 
            background: linear-gradient(135deg, var(--custom-primary, #ff6b35), var(--custom-secondary, #00d4aa)); 
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .custom-colors {
            margin-top: var(--space-sm);
            padding: var(--space-sm);
            background: var(--bg-glass);
            border-radius: var(--radius-md);
        }

        .custom-color-row {
            display: flex;
            gap: var(--space-md);
        }

        .custom-color-row label {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .custom-color-row label span {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .custom-color-row input[type="color"] {
            width: 100%;
            height: 40px;
            border: 2px solid var(--border-glass);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            cursor: pointer;
            padding: 2px;
        }

        .custom-color-row input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .custom-color-row input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        /* Game Over */
        .game-over-modal {
            align-items: center;
            justify-content: center;
        }

        .game-over-content {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: var(--space-xl);
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            max-width: 400px;
            width: calc(100% - var(--space-md) * 2);
            margin: var(--space-md);
            animation: scaleIn 0.4s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .winner-icon {
            font-size: 3.5rem;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .winner-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 4px;
            background: linear-gradient(135deg, var(--theme-accent), var(--theme-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: var(--space-sm) 0;
        }

        .winner-name {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }

        .winner-stats {
            display: flex;
            justify-content: center;
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        .game-over-actions {
            display: flex;
            gap: var(--space-sm);
            justify-content: center;
        }

        /* Coin Toss Modal */
        #coinTossModal.open,
        #nearestBullModal.open {
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2500;
        }

        .coin-toss-content {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: var(--space-lg);
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            max-width: 360px;
            width: calc(100% - var(--space-lg) * 2);
            margin: var(--space-md);
            animation: scaleIn 0.4s ease;
        }

        .coin-container {
            perspective: 1000px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: var(--space-lg) 0;
        }

        .coin {
            width: 100px;
            height: 100px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s;
        }

        .coin.flipping {
            animation: coinFlip 2s ease-out forwards;
        }

        .coin.flipping.to-tails {
            animation: coinFlipTails 2s ease-out forwards;
        }

        @keyframes coinFlip {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(1800deg); }
        }

        @keyframes coinFlipTails {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(1980deg); }
        }

        .coin-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            backface-visibility: hidden;
            border: 4px solid rgba(255,255,255,0.2);
        }

        .coin-heads {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: white;
        }

        .coin-tails {
            background: linear-gradient(135deg, var(--theme-secondary), var(--theme-primary));
            color: white;
            transform: rotateY(180deg);
        }

        .coin-result {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--theme-primary);
            min-height: 2rem;
            margin-bottom: var(--space-sm);
        }

        .coin-winner {
            font-size: 1rem;
            color: var(--text-secondary);
            min-height: 1.5rem;
            margin-bottom: var(--space-md);
        }

        .coin-actions {
            display: flex;
            gap: var(--space-sm);
            justify-content: center;
            margin-bottom: var(--space-md);
        }

        .coin-start-btn {
            width: 100%;
        }

        /* Nearest Bull Modal */
        .nearest-bull-content {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: var(--space-lg);
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            max-width: 400px;
            width: calc(100% - var(--space-md) * 2);
            margin: var(--space-md);
            animation: scaleIn 0.4s ease;
        }

        .bull-instruction {
            font-size: 1.1rem;
            margin-bottom: var(--space-md);
            color: var(--text-secondary);
        }

        .bull-player-name {
            font-weight: 700;
            color: var(--theme-primary);
        }

        .bull-board-container {
            max-width: 280px;
            margin: 0 auto var(--space-md);
        }

        .bull-throws {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            justify-content: center;
            margin-bottom: var(--space-md);
            min-height: 40px;
        }

        .bull-throw-item {
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
        }

        .bull-throw-item.winner {
            background: var(--theme-primary);
            color: white;
        }

        .bull-winner {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--theme-primary);
            min-height: 1.5rem;
            margin-bottom: var(--space-md);
        }

        .bull-start-btn {
            width: 100%;
        }

        /* Magnifier */
        .magnifier-loupe {
            position: fixed;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.8);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            overflow: visible;
            pointer-events: none;
            z-index: 9999;
            background: #1a1a1a;
            display: none;
        }

        .magnifier-loupe.active {
            display: block;
        }

        .magnifier-loupe svg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
        }

        .magnifier-info {
            position: absolute;
            bottom: -36px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 10, 15, 0.95);
            padding: 6px 14px;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 700;
            white-space: nowrap;
            border: 2px solid currentColor;
            transition: color 0.1s, border-color 0.1s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        .magnifier-info.single { color: #f5f0dc; }
        .magnifier-info.double { color: #208b3a; }
        .magnifier-info.treble { color: #e23636; }
        .magnifier-info.bull { color: #e23636; }
        .magnifier-info.outer-bull { color: #208b3a; }
        .magnifier-info.miss { color: var(--text-muted); }

        .magnifier-hint {
            position: absolute;
            top: -24px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.65rem;
            color: var(--text-muted);
            opacity: 0.6;
        }

        .dartboard-crosshair {
            pointer-events: none;
        }

        @media (min-width: 768px) {
            .game-over-content {
                padding: var(--space-xl) calc(var(--space-xl) * 2);
            }

            .winner-icon {
                font-size: 5rem;
            }

            .winner-title {
                font-size: 2.5rem;
            }

            .winner-name {
                font-size: 1.25rem;
            }

            .winner-stats {
                gap: var(--space-xl);
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-lg);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.85rem;
            box-shadow: 0 4px 20px var(--shadow-color);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 5000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success { background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); color: white; }
        .toast.error { background: #e63946; color: white; }

        /* Desktop game layout */
        @media (min-width: 768px) {
            .game-layout {
                max-width: 100%;
            }

            .score-bar {
                max-width: 600px;
                margin: 0 auto;
                width: 100%;
                border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            }

            .game-info {
                max-width: 600px;
                margin: 0 auto;
                width: 100%;
            }

            .match-stats {
                max-width: 600px;
                margin: 0 auto;
                width: 100%;
            }

            .turn-display {
                max-width: 600px;
                margin: 0 auto;
                width: 100%;
            }

            .checkout-hint {
                max-width: 600px;
                margin: 0 auto;
                width: 100%;
            }

            .input-area {
                max-width: 700px;
                margin: 0 auto;
                width: 100%;
            }

            .action-bar {
                max-width: 600px;
                margin: 0 auto;
                width: 100%;
            }

            .dartboard-container {
                max-width: 380px;
            }

            .dartboard-number {
                font-size: 19px;
            }

            .player-score-main {
                font-size: 2rem;
            }
        }

        @media (min-width: 1024px) {
            .dartboard-container {
                max-width: 420px;
            }

            .dartboard-number {
                font-size: 20px;
            }

            .dart-slot {
                width: 56px;
                height: 42px;
                font-size: 0.9rem;
            }

            .player-score-main {
                font-size: 2.25rem;
            }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="app-bg">
        <div class="bg-orb bg-orb-1"></div>
        <div class="bg-orb bg-orb-2"></div>
    </div>

    <div class="app">
        <header class="header glass">
            <div class="logo">
                <div class="logo-icon">ðŸŽ¯</div>
                <span class="logo-text">D.E.A.N.O</span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="statsBtn">ðŸ“Š</button>
                <button class="icon-btn" id="settingsBtn">âš™ï¸</button>
            </div>
        </header>

        <nav class="nav">
            <button class="nav-btn active" data-nav="home"><span>ðŸ </span>Home</button>
            <button class="nav-btn" data-nav="play"><span>ðŸŽ®</span>Play</button>
            <button class="nav-btn" data-nav="practice"><span>ðŸŽ¯</span>Practice</button>
            <button class="nav-btn" data-nav="learn"><span>ðŸ“š</span>Learn</button>
        </nav>

        <main class="main">
            <!-- HOME -->
            <section class="screen active" id="screen-home">
                <div class="screen-content">
                    <div class="home-hero">
                        <h1 class="hero-title">D.E.A.N.O</h1>
                        <p class="hero-sub">Darts Education & Analytics for Next-level Outcomes</p>
                    </div>
                    <div class="home-grid">
                        <div class="home-card glass featured" data-action="quick-game">
                            <div class="card-icon">âš¡</div>
                            <div class="card-title">QUICK 501</div>
                            <div class="card-desc">Jump straight into a game</div>
                        </div>
                        <div class="home-card glass" data-action="new-game">
                            <div class="card-icon">ðŸŽ®</div>
                            <div class="card-title">NEW GAME</div>
                            <div class="card-desc">Custom setup</div>
                        </div>
                        <div class="home-card glass" data-action="practice">
                            <div class="card-icon">ðŸŽ¯</div>
                            <div class="card-title">PRACTICE</div>
                            <div class="card-desc">Drills & training</div>
                        </div>
                        <div class="home-card glass" data-action="checkouts">
                            <div class="card-icon">ðŸ“‹</div>
                            <div class="card-title">CHECKOUTS</div>
                            <div class="card-desc">PDC chart</div>
                        </div>
                        <div class="home-card glass" data-action="stats">
                            <div class="card-icon">ðŸ“ˆ</div>
                            <div class="card-title">STATS</div>
                            <div class="card-desc">Your progress</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PLAY -->
            <section class="screen" id="screen-play">
                <div class="screen-content">
                    <div class="setup-section glass-solid">
                        <div class="section-title">ðŸŽ® Game Type</div>
                        <div class="option-row" id="gameTypeOpts">
                            <button class="option-btn" data-val="301">301</button>
                            <button class="option-btn selected" data-val="501">501</button>
                            <button class="option-btn" data-val="701">701</button>
                        </div>
                    </div>

                    <div class="setup-section glass-solid">
                        <div class="section-title">ðŸŽ¯ Out Mode</div>
                        <div class="option-row" id="outModeOpts">
                            <button class="option-btn" data-val="straight">Straight</button>
                            <button class="option-btn selected" data-val="double">Double</button>
                            <button class="option-btn" data-val="master">Master</button>
                        </div>
                    </div>

                    <div class="setup-section glass-solid">
                        <div class="section-title">ðŸ† Format</div>
                        <div class="option-row">
                            <div style="flex:1">
                                <div style="font-size:0.65rem;color:var(--text-muted);margin-bottom:4px;">Legs (first to)</div>
                                <div class="option-row" id="legsOpts">
                                    <button class="option-btn selected" data-val="1">1</button>
                                    <button class="option-btn" data-val="3">3</button>
                                    <button class="option-btn" data-val="5">5</button>
                                    <button class="option-btn" data-val="7">7</button>
                                </div>
                            </div>
                        </div>
                        <div class="option-row" style="margin-top:var(--space-sm)">
                            <div style="flex:1">
                                <div style="font-size:0.65rem;color:var(--text-muted);margin-bottom:4px;">Sets (first to)</div>
                                <div class="option-row" id="setsOpts">
                                    <button class="option-btn selected" data-val="1">1</button>
                                    <button class="option-btn" data-val="3">3</button>
                                    <button class="option-btn" data-val="5">5</button>
                                    <button class="option-btn" data-val="7">7</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="setup-section glass-solid">
                        <div class="section-title">ðŸ‘¥ Players</div>
                        <div class="players-list" id="playersList"></div>
                        <button class="add-btn" id="addPlayerBtn">+ Add Player</button>
                    </div>

                    <div class="setup-section glass-solid">
                        <div class="section-title">ðŸŽ² Who Throws First?</div>
                        <div class="option-row" id="firstThrowOpts">
                            <button class="option-btn selected" data-val="p1">Player 1</button>
                            <button class="option-btn" data-val="coin">Coin Toss</button>
                            <button class="option-btn" data-val="bull">Nearest Bull</button>
                        </div>
                    </div>

                    <div class="setup-actions">
                        <button class="action-btn primary" id="startGameBtn" style="flex:2">Start Game â†’</button>
                    </div>
                </div>
            </section>

            <!-- GAME -->
            <section class="screen" id="screen-game">
                <div class="game-layout">
                    <div class="score-bar" id="scoreBar"></div>
                    <div class="game-info">
                        <span class="game-badge" id="gameBadge">501</span>
                        <span id="matchInfo">Leg 1</span>
                    </div>
                    <div class="match-stats" id="matchStats">
                        <div class="match-stat"><span class="match-stat-val" id="msTons">0</span><br>100+</div>
                        <div class="match-stat"><span class="match-stat-val" id="ms140">0</span><br>140+</div>
                        <div class="match-stat"><span class="match-stat-val" id="ms180">0</span><br>180</div>
                        <div class="match-stat"><span class="match-stat-val" id="msFirst9">-</span><br>First 9</div>
                    </div>
                    <div class="turn-display">
                        <div class="darts-thrown">
                            <div class="dart-slot current" id="dart0">-</div>
                            <div class="dart-slot" id="dart1">-</div>
                            <div class="dart-slot" id="dart2">-</div>
                        </div>
                        <div class="turn-total">
                            <div class="turn-total-label">Turn</div>
                            <div class="turn-total-value" id="turnTotal">0</div>
                        </div>
                    </div>
                    <div class="checkout-hint hidden" id="checkoutHint">
                        <div class="checkout-row" id="checkoutContinue" style="display:none">
                            <span class="checkout-label">Continue:</span>
                            <span class="checkout-path continue" id="checkoutContinuePath"></span>
                        </div>
                        <div class="checkout-row">
                            <span class="checkout-label">ðŸ’¡ Route:</span>
                            <span class="checkout-path" id="checkoutPath"></span>
                        </div>
                        <div class="checkout-row" id="checkoutAltRow" style="display:none">
                            <span class="checkout-label">Alt:</span>
                            <span class="checkout-alt" id="checkoutAlt"></span>
                        </div>
                    </div>
                    <div class="input-area">
                        <div class="input-tabs">
                            <button class="input-tab active" data-tab="board">Board</button>
                            <button class="input-tab" data-tab="darts">Darts</button>
                            <button class="input-tab" data-tab="quick">Quick</button>
                            <button class="input-tab" data-tab="numpad">Numpad</button>
                        </div>
                        
                        <div class="input-panel active" id="panel-board">
                            <div class="dartboard-wrap">
                                <div class="magnifier-hint" id="magnifierHint">Hold Ctrl for magnifier</div>
                                <button class="fullscreen-btn" id="fullscreenBtn">â›¶</button>
                                <div class="dartboard-container">
                                    <svg class="dartboard-svg" viewBox="0 0 400 400" id="dartboardSvg"></svg>
                                </div>
                            </div>
                        </div>

                        <div class="input-panel" id="panel-darts">
                            <div class="darts-input">
                                <div class="multiplier-bar">
                                    <button class="mult-btn active" data-mult="1">Single</button>
                                    <button class="mult-btn" data-mult="2">Double</button>
                                    <button class="mult-btn" data-mult="3">Treble</button>
                                </div>
                                <div class="darts-grid" id="dartsGrid"></div>
                            </div>
                        </div>

                        <div class="input-panel" id="panel-quick">
                            <div style="font-size:0.6rem;color:var(--text-muted);text-align:center;margin-bottom:var(--space-sm);">
                                Enter your 3-dart turn total
                            </div>
                            <div class="quick-grid" id="quickGrid"></div>
                        </div>

                        <div class="input-panel" id="panel-numpad">
                            <div style="font-size:0.6rem;color:var(--text-muted);text-align:center;margin-bottom:var(--space-sm);">
                                Enter your 3-dart turn total (max 180)
                            </div>
                            <div class="numpad-wrap">
                                <div class="numpad-display" id="numpadDisplay">-</div>
                                <div class="numpad-grid" id="numpadGrid"></div>
                            </div>
                        </div>
                    </div>
                    <div class="action-bar">
                        <button class="action-btn danger" id="undoBtn">â†©</button>
                        <button class="action-btn secondary" id="missBtn">Miss</button>
                        <button class="fullscreen-btn-bar" id="fullscreenBtnBar">â›¶</button>
                        <button class="action-btn primary" id="nextBtn">Next â†’</button>
                    </div>
                </div>
            </section>

            <!-- PRACTICE -->
            <section class="screen" id="screen-practice">
                <div class="screen-content">
                    <div class="practice-list">
                        <div class="practice-card glass" data-practice="doubles">
                            <div class="practice-icon">ðŸŽ¯</div>
                            <div class="practice-info">
                                <div class="practice-title">DOUBLES PRACTICE</div>
                                <div class="practice-desc">Hit each double around the board</div>
                            </div>
                            <div class="practice-arrow">â†’</div>
                        </div>
                        <div class="practice-card glass" data-practice="around">
                            <div class="practice-icon">ðŸ”„</div>
                            <div class="practice-info">
                                <div class="practice-title">AROUND THE CLOCK</div>
                                <div class="practice-desc">Hit 1 through 20 in order</div>
                            </div>
                            <div class="practice-arrow">â†’</div>
                        </div>
                        <div class="practice-card glass" data-practice="trebles">
                            <div class="practice-icon">ðŸ”º</div>
                            <div class="practice-info">
                                <div class="practice-title">TREBLES PRACTICE</div>
                                <div class="practice-desc">Hit each treble around the board</div>
                            </div>
                            <div class="practice-arrow">â†’</div>
                        </div>
                        <div class="practice-card glass" data-practice="checkout">
                            <div class="practice-icon">âœ…</div>
                            <div class="practice-info">
                                <div class="practice-title">CHECKOUT PRACTICE</div>
                                <div class="practice-desc">Random checkouts from 2-170</div>
                            </div>
                            <div class="practice-arrow">â†’</div>
                        </div>
                        <div class="practice-card glass" data-practice="random">
                            <div class="practice-icon">ðŸŽ²</div>
                            <div class="practice-info">
                                <div class="practice-title">RANDOM TARGET</div>
                                <div class="practice-desc">Hit the segment shown</div>
                            </div>
                            <div class="practice-arrow">â†’</div>
                        </div>
                        <div class="practice-card glass" data-practice="bob27">
                            <div class="practice-icon">ðŸ’¯</div>
                            <div class="practice-info">
                                <div class="practice-title">BOB'S 27</div>
                                <div class="practice-desc">Classic doubles challenge</div>
                            </div>
                            <div class="practice-arrow">â†’</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PRACTICE GAME -->
            <section class="screen" id="screen-practice-game">
                <div class="game-layout">
                    <div class="practice-header">
                        <div class="practice-game-title" id="practiceTitle">PRACTICE</div>
                    </div>
                    <div class="practice-target">
                        <div class="target-label" id="practiceLabel">Target</div>
                        <div class="target-value" id="practiceTarget">D20</div>
                        <div class="target-sub" id="practiceSub"></div>
                    </div>
                    <div class="practice-stats">
                        <div class="practice-stat">
                            <div class="practice-stat-value" id="practiceHits">0</div>
                            <div class="practice-stat-label">Hits</div>
                        </div>
                        <div class="practice-stat">
                            <div class="practice-stat-value" id="practiceDarts">0</div>
                            <div class="practice-stat-label">Darts</div>
                        </div>
                        <div class="practice-stat">
                            <div class="practice-stat-value" id="practiceScore">0</div>
                            <div class="practice-stat-label">Score</div>
                        </div>
                    </div>
                    <div class="input-area">
                        <div class="dartboard-wrap">
                            <div class="dartboard-container">
                                <svg class="dartboard-svg" viewBox="0 0 400 400" id="practiceBoardSvg"></svg>
                            </div>
                        </div>
                    </div>
                    <div class="action-bar">
                        <button class="action-btn secondary" id="practiceExitBtn">â† Exit</button>
                        <button class="action-btn danger" id="practiceResetBtn">Reset</button>
                    </div>
                </div>
            </section>

            <!-- LEARN -->
            <section class="screen" id="screen-learn">
                <div class="screen-content">
                    <div class="checkout-chart glass-solid" id="checkoutChart"></div>
                </div>
            </section>

            <!-- STATS -->
            <section class="screen" id="screen-stats">
                <div class="screen-content">
                    <div class="stats-grid">
                        <div class="stat-card glass featured">
                            <div class="stat-value" id="statAvg">0.00</div>
                            <div class="stat-label">3-Dart Average</div>
                        </div>
                        <div class="stat-card glass">
                            <div class="stat-value" id="statFirst9">0.00</div>
                            <div class="stat-label">First 9 Avg</div>
                        </div>
                        <div class="stat-card glass">
                            <div class="stat-value" id="statCheckout">0%</div>
                            <div class="stat-label">Checkout %</div>
                        </div>
                        <div class="stat-card glass">
                            <div class="stat-value" id="statGames">0</div>
                            <div class="stat-label">Games</div>
                        </div>
                        <div class="stat-card glass">
                            <div class="stat-value" id="statWins">0</div>
                            <div class="stat-label">Wins</div>
                        </div>
                        <div class="stat-card glass">
                            <div class="stat-value" id="stat180s">0</div>
                            <div class="stat-label">180s</div>
                        </div>
                        <div class="stat-card glass">
                            <div class="stat-value" id="statHighCo">0</div>
                            <div class="stat-label">Best Checkout</div>
                        </div>
                        <div class="stat-card glass">
                            <div class="stat-value" id="statTons">0</div>
                            <div class="stat-label">100+ Scores</div>
                        </div>
                        <div class="stat-card glass">
                            <div class="stat-value" id="statDarts">0</div>
                            <div class="stat-label">Total Darts</div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Fullscreen Mode -->
    <!-- Fullscreen Game Mode -->
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <div class="fs-header">
            <div class="fs-player-panel active" id="fsPlayer0">
                <div class="fs-player-name">Player 1</div>
                <div class="fs-player-score">501</div>
                <div class="fs-player-meta">
                    <span>Avg <span class="val">0.0</span></span>
                    <span>L<span class="val">0</span></span>
                </div>
            </div>
            <div class="fs-center-info">
                <span class="fs-match-info" id="fsMatchInfo">501 â€¢ Leg 1</span>
                <button class="fs-close" id="fsClose">âœ•</button>
            </div>
            <div class="fs-player-panel right" id="fsPlayer1">
                <div class="fs-player-name">Player 2</div>
                <div class="fs-player-score">501</div>
                <div class="fs-player-meta">
                    <span>Avg <span class="val">0.0</span></span>
                    <span>L<span class="val">0</span></span>
                </div>
            </div>
            <!-- Practice Target Panel (hidden by default) -->
            <div class="fs-practice-panel" id="fsPracticePanel" style="display:none">
                <div class="fs-practice-label" id="fsPracticeLabel">Target</div>
                <div class="fs-practice-target" id="fsPracticeTarget">D20</div>
                <div class="fs-practice-sub" id="fsPracticeSub">1 of 20</div>
            </div>
        </div>

        <div class="fs-content">
            <div class="fs-input-tabs" id="fsInputTabs">
                <button class="fs-input-tab active" data-fstab="board">Board</button>
                <button class="fs-input-tab" data-fstab="darts">Darts</button>
                <button class="fs-input-tab" data-fstab="quick">Quick</button>
                <button class="fs-input-tab" data-fstab="numpad">Numpad</button>
            </div>

            <div class="fs-input-area">
                <!-- Board Panel -->
                <div class="fs-input-panel fs-board-panel active" id="fs-panel-board">
                    <div class="dartboard-container">
                        <svg class="dartboard-svg" viewBox="0 0 400 400" id="fsBoardSvg"></svg>
                    </div>
                </div>

                <!-- Darts Panel -->
                <div class="fs-input-panel fs-darts-panel" id="fs-panel-darts">
                    <div class="fs-mult-bar">
                        <button class="fs-mult-btn active" data-fsmult="1">Single</button>
                        <button class="fs-mult-btn" data-fsmult="2">Double</button>
                        <button class="fs-mult-btn" data-fsmult="3">Treble</button>
                    </div>
                    <div class="fs-darts-grid" id="fsDartsGrid"></div>
                </div>

                <!-- Quick Panel -->
                <div class="fs-input-panel fs-quick-panel" id="fs-panel-quick">
                    <div class="hint">Enter your 3-dart turn total</div>
                    <div class="fs-quick-grid" id="fsQuickGrid"></div>
                </div>

                <!-- Numpad Panel -->
                <div class="fs-input-panel fs-numpad-panel" id="fs-panel-numpad">
                    <div class="hint">Enter your 3-dart turn total</div>
                    <div class="fs-numpad-wrap">
                        <div class="fs-numpad-display" id="fsNumpadDisplay">-</div>
                        <div class="fs-numpad-grid" id="fsNumpadGrid"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="fs-bottom">
            <div class="fs-turn-bar">
                <div class="fs-darts">
                    <div class="fs-dart" id="fsDart0">-</div>
                    <div class="fs-dart" id="fsDart1">-</div>
                    <div class="fs-dart" id="fsDart2">-</div>
                </div>
                <div class="fs-total" id="fsTotal">0</div>
            </div>
            <div class="fs-actions" id="fsActions">
                <button class="action-btn danger" id="fsUndo">â†© Undo</button>
                <button class="action-btn secondary" id="fsMiss">Miss</button>
                <button class="action-btn primary" id="fsNext">Next â†’</button>
            </div>
            <!-- Practice Actions (hidden by default) -->
            <div class="fs-actions" id="fsPracticeActions" style="display:none">
                <button class="action-btn secondary" id="fsPracticeExit">â† Exit</button>
                <button class="action-btn danger" id="fsPracticeReset">Reset</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-backdrop" data-close="settings"></div>
        <div class="modal-content glass-solid">
            <div class="modal-handle"></div>
            <div class="modal-title">Settings</div>
            <div class="settings-group">
                <div class="settings-label">Theme</div>
                <div class="toggle-row">
                    <button class="toggle-btn active" data-theme="dark">ðŸŒ™ Dark</button>
                    <button class="toggle-btn" data-theme="light">â˜€ï¸ Light</button>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-label">Color</div>
                <div class="color-row">
                    <button class="color-btn color-ember active" data-color="ember"></button>
                    <button class="color-btn color-ocean" data-color="ocean"></button>
                    <button class="color-btn color-forest" data-color="forest"></button>
                    <button class="color-btn color-royal" data-color="royal"></button>
                    <button class="color-btn color-crimson" data-color="crimson"></button>
                    <button class="color-btn color-mono" data-color="mono"></button>
                    <button class="color-btn color-custom" data-color="custom">âœŽ</button>
                </div>
                <div class="custom-colors" id="customColors" style="display:none">
                    <div class="custom-color-row">
                        <label>
                            <span>Primary</span>
                            <input type="color" id="customPrimary" value="#ff6b35">
                        </label>
                        <label>
                            <span>Secondary</span>
                            <input type="color" id="customSecondary" value="#00d4aa">
                        </label>
                    </div>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-label">Sound</div>
                <div class="toggle-row">
                    <button class="toggle-btn" data-sound="on">ðŸ”Š On</button>
                    <button class="toggle-btn active" data-sound="off">ðŸ”‡ Off</button>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-label">Checkout Preference</div>
                <div class="toggle-row" style="flex-wrap: wrap; gap: var(--space-xs);">
                    <button class="toggle-btn active" data-checkout="pdc" style="flex: 1 1 45%;">PDC Standard</button>
                    <button class="toggle-btn" data-checkout="bull" style="flex: 1 1 45%;">Bull Preferred</button>
                    <button class="toggle-btn" data-checkout="t20" style="flex: 1 1 45%;">T20 Side</button>
                    <button class="toggle-btn" data-checkout="safe" style="flex: 1 1 45%;">Safe Routes</button>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-label">Haptics</div>
                <div class="toggle-row">
                    <button class="toggle-btn active" data-haptic="on">ðŸ“³ On</button>
                    <button class="toggle-btn" data-haptic="off">ðŸ“´ Off</button>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-label">Auto Fullscreen (Mobile)</div>
                <div class="toggle-row">
                    <button class="toggle-btn active" data-autofs="on">âœ“ On</button>
                    <button class="toggle-btn" data-autofs="off">âœ— Off</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div class="modal game-over-modal" id="gameOverModal">
        <div class="modal-backdrop"></div>
        <div class="game-over-content">
            <div class="winner-icon">ðŸ†</div>
            <div class="winner-title">GAME OVER</div>
            <div class="winner-name" id="winnerName">Player 1 Wins!</div>
            <div class="winner-stats">
                <div class="practice-stat">
                    <div class="practice-stat-value" id="winnerAvg">0.00</div>
                    <div class="practice-stat-label">Average</div>
                </div>
                <div class="practice-stat">
                    <div class="practice-stat-value" id="winnerCheckout">0</div>
                    <div class="practice-stat-label">Checkout</div>
                </div>
                <div class="practice-stat">
                    <div class="practice-stat-value" id="winnerDarts">0</div>
                    <div class="practice-stat-label">Darts</div>
                </div>
            </div>
            <div class="game-over-actions">
                <button class="action-btn secondary" data-action="home">Home</button>
                <button class="action-btn primary" data-action="rematch">Rematch</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Magnifier Loupe -->
    <div class="magnifier-loupe" id="magnifierLoupe">
        <svg viewBox="0 0 70 70" id="magnifierSvg"></svg>
        <div class="magnifier-info" id="magnifierInfo">-</div>
    </div>

    <!-- Coin Toss Modal -->
    <div class="modal" id="coinTossModal">
        <div class="modal-backdrop"></div>
        <div class="modal-content glass-solid coin-toss-content">
            <div class="modal-title">Coin Toss</div>
            <div class="coin-container">
                <div class="coin" id="coin">
                    <div class="coin-face coin-heads">H</div>
                    <div class="coin-face coin-tails">T</div>
                </div>
            </div>
            <div class="coin-result" id="coinResult"></div>
            <div class="coin-winner" id="coinWinner"></div>
            <div class="coin-actions">
                <button class="action-btn secondary" id="coinHeadsBtn">Heads</button>
                <button class="action-btn secondary" id="coinTailsBtn">Tails</button>
            </div>
            <button class="action-btn primary coin-start-btn" id="coinStartBtn" style="display:none">Start Game</button>
        </div>
    </div>

    <!-- Nearest Bull Modal -->
    <div class="modal" id="nearestBullModal">
        <div class="modal-backdrop"></div>
        <div class="modal-content glass-solid nearest-bull-content">
            <div class="modal-title">Nearest to Bull</div>
            <div class="bull-instruction" id="bullInstruction">
                <span class="bull-player-name" id="bullCurrentPlayer">Player 1</span>
                <span class="bull-text">throw at the bull!</span>
            </div>
            <div class="bull-board-container">
                <svg class="dartboard-svg" viewBox="0 0 400 400" id="bullBoardSvg"></svg>
            </div>
            <div class="bull-throws" id="bullThrows"></div>
            <div class="bull-winner" id="bullWinner"></div>
            <button class="action-btn primary bull-start-btn" id="bullStartBtn" style="display:none">Start Game</button>
        </div>
    </div>

    <script>
    // =====================================================
    // D.E.A.N.O - DARTS EDUCATION & ANALYTICS FOR NEXT-LEVEL OUTCOMES
    // Full PDC Checkout Chart with alternatives
    // =====================================================

    // PDC Standard Checkout Chart with alternatives
    const CHECKOUTS = {
        170: { primary: 'T20 T20 Bull', alt: [] },
        167: { primary: 'T20 T19 Bull', alt: [] },
        164: { primary: 'T20 T18 Bull', alt: ['T19 T19 Bull'] },
        161: { primary: 'T20 T17 Bull', alt: ['T19 T18 Bull'] },
        160: { primary: 'T20 T20 D20', alt: [] },
        158: { primary: 'T20 T20 D19', alt: [] },
        157: { primary: 'T20 T19 D20', alt: ['T19 T20 D20'] },
        156: { primary: 'T20 T20 D18', alt: [] },
        155: { primary: 'T20 T19 D19', alt: [] },
        154: { primary: 'T20 T18 D20', alt: ['T19 T19 D20'] },
        153: { primary: 'T20 T19 D18', alt: [] },
        152: { primary: 'T20 T20 D16', alt: [] },
        151: { primary: 'T20 T17 D20', alt: ['T19 T18 D20'] },
        150: { primary: 'T20 T18 D18', alt: ['T19 T19 D18'] },
        149: { primary: 'T20 T19 D16', alt: [] },
        148: { primary: 'T20 T20 D14', alt: ['T18 T18 D20'] },
        147: { primary: 'T20 T17 D18', alt: ['T19 T18 D18'] },
        146: { primary: 'T20 T18 D16', alt: ['T19 T19 D16'] },
        145: { primary: 'T20 T19 D14', alt: ['T20 T15 D20'] },
        144: { primary: 'T20 T20 D12', alt: [] },
        143: { primary: 'T20 T17 D16', alt: ['T19 T18 D16'] },
        142: { primary: 'T20 T14 D20', alt: ['T19 T19 D14'] },
        141: { primary: 'T20 T19 D12', alt: ['T17 T18 D18'] },
        140: { primary: 'T20 T20 D10', alt: ['T20 T16 D16'] },
        139: { primary: 'T20 T13 D20', alt: ['T19 T14 D20'] },
        138: { primary: 'T20 T18 D12', alt: ['T19 T19 D12'] },
        137: { primary: 'T20 T19 D10', alt: ['T18 T17 D16'] },
        136: { primary: 'T20 T20 D8', alt: ['T20 T16 D14'] },
        135: { primary: 'T20 T17 D12', alt: ['T20 T15 D15'] },
        134: { primary: 'T20 T14 D16', alt: ['T20 T18 D10'] },
        133: { primary: 'T20 T19 D8', alt: ['T20 T11 D16'] },
        132: { primary: 'T20 T16 D12', alt: ['Bull T14 D20'] },
        131: { primary: 'T20 T13 D16', alt: ['T19 T14 D16'] },
        130: { primary: 'T20 T18 D8', alt: ['T20 T10 D20'] },
        129: { primary: 'T19 T16 D12', alt: ['T20 T19 D6'] },
        128: { primary: 'T18 T14 D16', alt: ['T20 T18 D7'] },
        127: { primary: 'T20 T17 D8', alt: ['T20 T9 D20'] },
        126: { primary: 'T19 T19 D6', alt: ['T19 T15 D12'] },
        125: { primary: 'T18 T19 D7', alt: ['T20 T15 D10', '25 T20 D20'] },
        124: { primary: 'T20 T16 D8', alt: ['T20 T14 D11'] },
        123: { primary: 'T19 T16 D9', alt: ['T20 T13 D12'] },
        122: { primary: 'T18 T18 D7', alt: ['T20 T10 D16'] },
        121: { primary: 'T20 T11 D14', alt: ['T17 T18 D11'] },
        120: { primary: 'T20 S20 D20', alt: ['T20 T12 D12'] },
        119: { primary: 'T19 T12 D13', alt: ['T20 S19 D20'] },
        118: { primary: 'T20 S18 D20', alt: ['T18 T12 D16'] },
        117: { primary: 'T20 S17 D20', alt: ['T19 S20 D20'] },
        116: { primary: 'T20 S16 D20', alt: ['T19 S19 D20'] },
        115: { primary: 'T20 S15 D20', alt: ['T19 S18 D20'] },
        114: { primary: 'T20 S14 D20', alt: ['T19 S17 D20'] },
        113: { primary: 'T20 S13 D20', alt: ['T19 S16 D20'] },
        112: { primary: 'T20 T12 D8', alt: ['T20 S12 D20'] },
        111: { primary: 'T20 S19 D16', alt: ['T19 S14 D20'] },
        110: { primary: 'T20 S18 D16', alt: ['T20 Bull'] },
        109: { primary: 'T20 S17 D16', alt: ['T19 S12 D20'] },
        108: { primary: 'T20 S16 D16', alt: ['T19 S19 D16'] },
        107: { primary: 'T19 S18 D16', alt: ['T20 S15 D16'] },
        106: { primary: 'T20 S14 D16', alt: ['T20 S6 D20'] },
        105: { primary: 'T20 S13 D16', alt: ['T19 S16 D16'] },
        104: { primary: 'T18 S18 D16', alt: ['T20 S12 D16'] },
        103: { primary: 'T19 S10 D18', alt: ['T17 S12 D20'] },
        102: { primary: 'T20 S10 D16', alt: ['T20 S6 D18'] },
        101: { primary: 'T17 S10 D20', alt: ['T20 S9 D16'] },
        100: { primary: 'T20 D20', alt: [] },
        99: { primary: 'T19 S10 D16', alt: ['T19 S6 D18'] },
        98: { primary: 'T20 D19', alt: [] },
        97: { primary: 'T19 D20', alt: [] },
        96: { primary: 'T20 D18', alt: [] },
        95: { primary: 'T19 D19', alt: ['T15 D25'] },
        94: { primary: 'T18 D20', alt: [] },
        93: { primary: 'T19 D18', alt: [] },
        92: { primary: 'T20 D16', alt: [] },
        91: { primary: 'T17 D20', alt: [] },
        90: { primary: 'T18 D18', alt: ['T20 D15'] },
        89: { primary: 'T19 D16', alt: [] },
        88: { primary: 'T20 D14', alt: ['T16 D20'] },
        87: { primary: 'T17 D18', alt: [] },
        86: { primary: 'T18 D16', alt: [] },
        85: { primary: 'T15 D20', alt: ['T19 D14'] },
        84: { primary: 'T20 D12', alt: [] },
        83: { primary: 'T17 D16', alt: [] },
        82: { primary: 'T14 D20', alt: ['Bull D16'] },
        81: { primary: 'T19 D12', alt: ['T15 D18'] },
        80: { primary: 'T20 D10', alt: ['T16 D16'] },
        79: { primary: 'T13 D20', alt: ['T19 D11'] },
        78: { primary: 'T18 D12', alt: [] },
        77: { primary: 'T19 D10', alt: ['T15 D16'] },
        76: { primary: 'T20 D8', alt: ['T16 D14'] },
        75: { primary: 'T17 D12', alt: ['T15 D15'] },
        74: { primary: 'T14 D16', alt: ['T18 D10'] },
        73: { primary: 'T19 D8', alt: ['T17 D11'] },
        72: { primary: 'T16 D12', alt: ['T12 D18'] },
        71: { primary: 'T13 D16', alt: ['T17 D10'] },
        70: { primary: 'T18 D8', alt: ['T10 D20'] },
        69: { primary: 'T19 D6', alt: ['T15 D12'] },
        68: { primary: 'T20 D4', alt: ['T16 D10'] },
        67: { primary: 'T17 D8', alt: ['T9 D20'] },
        66: { primary: 'T10 D18', alt: ['T14 D12'] },
        65: { primary: 'T11 D16', alt: ['T19 D4'] },
        64: { primary: 'T16 D8', alt: ['T14 D11'] },
        63: { primary: 'T13 D12', alt: ['T17 D6'] },
        62: { primary: 'T10 D16', alt: ['T12 D13'] },
        61: { primary: 'T15 D8', alt: ['T11 D14'] },
        60: { primary: 'S20 D20', alt: [] },
        59: { primary: 'S19 D20', alt: [] },
        58: { primary: 'S18 D20', alt: [] },
        57: { primary: 'S17 D20', alt: [] },
        56: { primary: 'T16 D4', alt: ['S16 D20'] },
        55: { primary: 'S15 D20', alt: [] },
        54: { primary: 'S14 D20', alt: [] },
        53: { primary: 'S13 D20', alt: [] },
        52: { primary: 'T12 D8', alt: ['S12 D20'] },
        51: { primary: 'S11 D20', alt: [] },
        50: { primary: 'S10 D20', alt: ['Bull'] },
        49: { primary: 'S9 D20', alt: [] },
        48: { primary: 'S16 D16', alt: ['S8 D20'] },
        47: { primary: 'S15 D16', alt: ['S7 D20'] },
        46: { primary: 'S6 D20', alt: ['S14 D16'] },
        45: { primary: 'S13 D16', alt: ['S5 D20'] },
        44: { primary: 'S12 D16', alt: ['S4 D20'] },
        43: { primary: 'S11 D16', alt: ['S3 D20'] },
        42: { primary: 'S10 D16', alt: ['S2 D20'] },
        41: { primary: 'S9 D16', alt: ['S1 D20'] },
        40: { primary: 'D20', alt: [] },
        39: { primary: 'S7 D16', alt: ['S19 D10'] },
        38: { primary: 'D19', alt: ['S6 D16'] },
        37: { primary: 'S5 D16', alt: ['S17 D10'] },
        36: { primary: 'D18', alt: [] },
        35: { primary: 'S3 D16', alt: ['S15 D10'] },
        34: { primary: 'D17', alt: ['S2 D16'] },
        33: { primary: 'S1 D16', alt: ['S13 D10'] },
        32: { primary: 'D16', alt: [] },
        31: { primary: 'S7 D12', alt: ['S11 D10'] },
        30: { primary: 'D15', alt: ['S10 D10'] },
        29: { primary: 'S13 D8', alt: ['S9 D10'] },
        28: { primary: 'D14', alt: [] },
        27: { primary: 'S11 D8', alt: ['S7 D10'] },
        26: { primary: 'D13', alt: ['S10 D8'] },
        25: { primary: 'S9 D8', alt: ['S5 D10'] },
        24: { primary: 'D12', alt: [] },
        23: { primary: 'S7 D8', alt: ['S3 D10'] },
        22: { primary: 'D11', alt: [] },
        21: { primary: 'S5 D8', alt: ['S1 D10'] },
        20: { primary: 'D10', alt: [] },
        19: { primary: 'S3 D8', alt: ['S11 D4'] },
        18: { primary: 'D9', alt: [] },
        17: { primary: 'S1 D8', alt: ['S9 D4'] },
        16: { primary: 'D8', alt: [] },
        15: { primary: 'S7 D4', alt: ['S3 D6'] },
        14: { primary: 'D7', alt: [] },
        13: { primary: 'S5 D4', alt: ['S1 D6'] },
        12: { primary: 'D6', alt: [] },
        11: { primary: 'S3 D4', alt: ['S7 D2'] },
        10: { primary: 'D5', alt: [] },
        9: { primary: 'S1 D4', alt: ['S5 D2'] },
        8: { primary: 'D4', alt: [] },
        7: { primary: 'S3 D2', alt: [] },
        6: { primary: 'D3', alt: [] },
        5: { primary: 'S1 D2', alt: [] },
        4: { primary: 'D2', alt: [] },
        3: { primary: 'S1 D1', alt: [] },
        2: { primary: 'D1', alt: [] }
    };

    const BOARD_ORDER = [20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];

    // Impossible 3-dart totals (no combination of 3 darts can make these)
    const IMPOSSIBLE_SCORES = [163, 166, 169, 172, 173, 175, 176, 178, 179];

    // Valid single dart scores (for dart-by-dart validation)
    const VALID_SINGLE_DART = new Set([
        0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
        21, 22, 24, 25, 26, 27, 28, 30, 32, 33, 34, 36, 38, 39, 40, 42, 45, 48, 
        50, 51, 54, 57, 60
    ]);

    // Validate a turn score (3-dart total)
    function isValidTurnScore(score) {
        if (score < 0 || score > 180) return false;
        if (IMPOSSIBLE_SCORES.includes(score)) return false;
        return true;
    }

    // Validate single dart score
    function isValidDartScore(value, mult) {
        if (value === 0) return true; // Miss
        if (value === 25) return mult === 1 || mult === 2; // 25 or Bull
        if (value < 1 || value > 20) return false;
        if (mult < 1 || mult > 3) return false;
        return true;
    }

    // Alternative checkout preferences
    const CHECKOUT_PREFS = {
        // Bull-preferred routes for certain scores
        bull: {
            50: 'Bull',
            60: 'S20 D20', // same
            82: 'Bull D16',
            90: 'T20 D15',
            95: 'T15 D25',
            100: 'T20 D20',
            107: 'T19 Bull',
            110: 'T20 Bull',
            114: 'T20 S14 D20',
            117: 'T17 Bull',
            121: 'T17 D25 D16', // actually T17 Bull D8
            125: '25 T20 D20',
            127: 'T20 T17 D8',
            131: 'T20 Bull D8 S3', // not valid, use default
            132: 'Bull T14 D20',
            135: '25 T20 D20 D5', // not valid
            139: 'T19 Bull D16',
            142: 'T20 Bull D16',
            145: 'T20 Bull D20 S5', // not valid
            147: 'T20 T17 D18',
            149: 'T20 Bull D16 T3', // not valid
            150: 'T20 Bull D20',
            152: 'T20 Bull D16 D5', // not valid
            154: 'T20 Bull D20 D2', // not valid
            157: 'T20 Bull D20 T9', // not valid, use T19 T20 D20
            160: 'T20 T20 D20',
            164: 'T19 T19 Bull',
            167: 'T20 T19 Bull',
            170: 'T20 T20 Bull'
        },
        // T20-side preferred (avoid T19 when possible)
        t20: {
            97: 'T20 S5 D16',
            99: 'T20 S7 D16',
            101: 'T20 S9 D16',
            103: 'T20 S11 D16',
            105: 'T20 S13 D16',
            107: 'T20 S15 D16',
            109: 'T20 S17 D16',
            111: 'T20 S19 D16'
        },
        // Safe routes (bigger doubles, avoid D1-D4)
        safe: {
            7: 'S3 D2', // same, can't avoid
            9: 'S1 D4', // same
            11: 'S3 D4', // same
            13: 'S5 D4', // same
            15: 'S7 D4', // same
            17: 'S9 D4',
            19: 'S11 D4',
            21: 'S13 D4',
            23: 'S15 D4',
            25: 'S17 D4',
            27: 'S19 D4',
            29: 'S5 D12',
            31: 'S7 D12',
            33: 'S9 D12',
            35: 'S11 D12'
        }
    };

    // Parse checkout route into array of {mult, value} objects
    function parseCheckoutRoute(route) {
        if (!route) return [];
        const parts = route.split(' ');
        return parts.map(p => {
            if (p === 'Bull') return { mult: 2, value: 25, score: 50, str: 'Bull' };
            if (p === '25') return { mult: 1, value: 25, score: 25, str: '25' };
            
            const firstChar = p[0];
            let mult = 1;
            let numStr = p;
            
            if (firstChar === 'T') {
                mult = 3;
                numStr = p.slice(1);
            } else if (firstChar === 'D') {
                mult = 2;
                numStr = p.slice(1);
            } else if (firstChar === 'S') {
                mult = 1;
                numStr = p.slice(1);
            }
            
            const value = parseInt(numStr) || 0;
            return { 
                mult, 
                value,
                score: value * mult,
                str: p
            };
        });
    }

    // Get checkout route based on preference
    function getCheckoutRoute(score, pref = 'pdc') {
        if (!CHECKOUTS[score]) return null;
        
        // Check if preference has an override for this score
        if (pref !== 'pdc' && CHECKOUT_PREFS[pref] && CHECKOUT_PREFS[pref][score]) {
            return {
                primary: CHECKOUT_PREFS[pref][score],
                alt: [CHECKOUTS[score].primary]
            };
        }
        
        return CHECKOUTS[score];
    }

    // Check if a throw matches expected dart in route
    function throwMatchesRoute(throwObj, routeDart) {
        if (!routeDart) return false;
        return throwObj.value === routeDart.value && throwObj.mult === routeDart.mult;
    }

    const app = {
        screen: 'home',
        settings: { 
            theme: 'dark', 
            color: 'ember', 
            sound: false, 
            haptic: true, 
            checkoutPref: 'pdc',
            customPrimary: '#ff6b35',
            customSecondary: '#00d4aa',
            autoFullscreen: true
        },
        stats: { 
            games: 0, wins: 0, darts: 0, score: 0, 
            one80s: 0, tons: 0, ton40s: 0, highCo: 0, 
            checkoutHit: 0, checkoutAtt: 0,
            first9Total: 0, first9Legs: 0
        },
        setup: { type: 501, out: 'double', legs: 1, sets: 1, players: ['Player 1', 'Player 2'], firstThrow: 'p1' },
        game: null,
        practice: null,
        multiplier: 1,
        numpadVal: '',
        fullscreen: false,
        fsInputMode: 'board',
        fsMultiplier: 1,
        fsNumpadVal: '',
        turnCheckout: null, // Track the checkout route for current turn
        coinToss: null, // Track coin toss state
        nearestBull: null, // Track nearest bull state
        magnifier: {
            active: false,
            x: 0,
            y: 0,
            svgX: 0,
            svgY: 0,
            targetSvg: null
        },
        ctrlPressed: false,
        isMobile: false,
        longPressTimer: null,
        touchStartTime: 0
    };

    // ===== INIT =====
    function init() {
        try {
            loadData();
            applySettings();
            applySetup();
            renderPlayers();
            initMagnifier();
            generateDartboard('dartboardSvg', handleGameThrow);
            generateDartboard('practiceBoardSvg', handlePracticeThrow);
            generateDartboard('fsBoardSvg', handleFsThrow);
            generateDartboard('bullBoardSvg', handleBullThrow);
            setupDartboardMagnifier('dartboardSvg', handleGameThrow);
            setupDartboardMagnifier('practiceBoardSvg', handlePracticeThrow);
            setupDartboardMagnifier('fsBoardSvg', handleFsThrow);
            generateDartsGrid();
            generateQuickGrid();
            generateNumpad();
            generateFsInputs(); // Generate fullscreen inputs
            generateCheckoutChart();
            bindEvents();
            updateGlobalStats();
            registerServiceWorker();
            console.log('D.E.A.N.O init complete');
        } catch (e) {
            console.error('Init error:', e);
        }
    }

    // Register PWA Service Worker
    function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered:', reg.scope))
                .catch(err => console.log('Service Worker registration failed:', err));
        }
    }
    
    // Combined fullscreen throw handler - works for both game and practice
    function handleFsThrow(seg) {
        const value = +seg.dataset.value;
        const mult = +seg.dataset.mult;
        
        if (app.practice) {
            handlePracticeFullscreenThrow(value, mult);
        } else if (app.game) {
            handleGameThrow(seg);
        }
    }

    function loadData() {
        const saved = localStorage.getItem('tungsten_v3');
        if (saved) {
            const data = JSON.parse(saved);
            if (data.settings) Object.assign(app.settings, data.settings);
            if (data.stats) Object.assign(app.stats, data.stats);
            if (data.setup) {
                // Restore saved setup preferences
                if (data.setup.type) app.setup.type = data.setup.type;
                if (data.setup.out) app.setup.out = data.setup.out;
                if (data.setup.legs) app.setup.legs = data.setup.legs;
                if (data.setup.sets) app.setup.sets = data.setup.sets;
                if (data.setup.firstThrow) app.setup.firstThrow = data.setup.firstThrow;
                if (data.setup.players && data.setup.players.length > 0) {
                    app.setup.players = data.setup.players;
                }
            }
        }
    }

    function saveData() {
        localStorage.setItem('tungsten_v3', JSON.stringify({
            settings: app.settings,
            stats: app.stats,
            setup: {
                type: app.setup.type,
                out: app.setup.out,
                legs: app.setup.legs,
                sets: app.setup.sets,
                firstThrow: app.setup.firstThrow,
                players: app.setup.players
            }
        }));
    }

    function applySettings() {
        document.documentElement.dataset.theme = app.settings.theme;
        document.documentElement.dataset.color = app.settings.color;
        
        // Apply custom colors to CSS variables
        document.documentElement.style.setProperty('--custom-primary', app.settings.customPrimary);
        document.documentElement.style.setProperty('--custom-secondary', app.settings.customSecondary);
        
        // Update custom color button preview
        const customBtn = document.querySelector('.color-custom');
        if (customBtn) {
            customBtn.style.background = `linear-gradient(135deg, ${app.settings.customPrimary}, ${app.settings.customSecondary})`;
        }
        
        // Show/hide custom color pickers
        const customColors = document.getElementById('customColors');
        if (customColors) {
            customColors.style.display = app.settings.color === 'custom' ? 'block' : 'none';
        }
        
        // Update color picker values
        const primaryPicker = document.getElementById('customPrimary');
        const secondaryPicker = document.getElementById('customSecondary');
        if (primaryPicker) primaryPicker.value = app.settings.customPrimary;
        if (secondaryPicker) secondaryPicker.value = app.settings.customSecondary;
        
        document.querySelectorAll('[data-theme]').forEach(b => 
            b.classList.toggle('active', b.dataset.theme === app.settings.theme));
        document.querySelectorAll('[data-color]').forEach(b => 
            b.classList.toggle('active', b.dataset.color === app.settings.color));
        document.querySelectorAll('[data-sound]').forEach(b => 
            b.classList.toggle('active', (b.dataset.sound === 'on') === app.settings.sound));
        document.querySelectorAll('[data-haptic]').forEach(b => 
            b.classList.toggle('active', (b.dataset.haptic === 'on') === app.settings.haptic));
        document.querySelectorAll('[data-checkout]').forEach(b => 
            b.classList.toggle('active', b.dataset.checkout === app.settings.checkoutPref));
        document.querySelectorAll('[data-autofs]').forEach(b => 
            b.classList.toggle('active', (b.dataset.autofs === 'on') === app.settings.autoFullscreen));
    }

    // ===== NAV =====
    function navigate(screen) {
        app.screen = screen;
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(`screen-${screen}`).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => 
            b.classList.toggle('active', b.dataset.nav === screen));
    }

    // ===== DARTBOARD =====
    function generateDartboard(svgId, clickHandler) {
        const svg = document.getElementById(svgId);
        const cx = 200, cy = 200;
        const r = { dblOut: 170, dblIn: 160, trbOut: 107, trbIn: 99, bullOut: 16, bullIn: 7 };
        
        let html = `<circle cx="${cx}" cy="${cy}" r="175" fill="#1a1a1a"/>`;
        
        const segAngle = 18;
        const startAngle = -99;

        BOARD_ORDER.forEach((num, i) => {
            const a1 = startAngle + i * segAngle;
            const a2 = startAngle + (i + 1) * segAngle;
            const isEven = i % 2 === 0;
            
            html += segment(cx, cy, r.dblIn, r.trbOut, a1, a2, 
                isEven ? '#1a1a1a' : '#f5f0dc', num, 1);
            html += segment(cx, cy, r.trbIn, r.bullOut, a1, a2,
                isEven ? '#1a1a1a' : '#f5f0dc', num, 1);
            html += segment(cx, cy, r.dblOut, r.dblIn, a1, a2,
                isEven ? '#e23636' : '#208b3a', num, 2);
            html += segment(cx, cy, r.trbOut, r.trbIn, a1, a2,
                isEven ? '#e23636' : '#208b3a', num, 3);
        });

        html += `<circle cx="${cx}" cy="${cy}" r="${r.bullOut}" class="dartboard-segment" 
            fill="#208b3a" data-value="25" data-mult="1"/>`;
        html += `<circle cx="${cx}" cy="${cy}" r="${r.bullIn}" class="dartboard-segment"
            fill="#e23636" data-value="25" data-mult="2"/>`;

        const wireColor = '#888';
        html += `<circle cx="${cx}" cy="${cy}" r="${r.dblOut}" fill="none" stroke="${wireColor}" stroke-width="1"/>`;
        html += `<circle cx="${cx}" cy="${cy}" r="${r.dblIn}" fill="none" stroke="${wireColor}" stroke-width="0.5"/>`;
        html += `<circle cx="${cx}" cy="${cy}" r="${r.trbOut}" fill="none" stroke="${wireColor}" stroke-width="0.5"/>`;
        html += `<circle cx="${cx}" cy="${cy}" r="${r.trbIn}" fill="none" stroke="${wireColor}" stroke-width="0.5"/>`;
        html += `<circle cx="${cx}" cy="${cy}" r="${r.bullOut}" fill="none" stroke="${wireColor}" stroke-width="0.5"/>`;
        html += `<circle cx="${cx}" cy="${cy}" r="${r.bullIn}" fill="none" stroke="${wireColor}" stroke-width="0.5"/>`;

        for (let i = 0; i < 20; i++) {
            const angle = (startAngle + i * segAngle) * Math.PI / 180;
            const x1 = cx + r.bullOut * Math.cos(angle);
            const y1 = cy + r.bullOut * Math.sin(angle);
            const x2 = cx + r.dblOut * Math.cos(angle);
            const y2 = cy + r.dblOut * Math.sin(angle);
            html += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${wireColor}" stroke-width="0.5"/>`;
        }

        BOARD_ORDER.forEach((num, i) => {
            const angle = (startAngle + i * segAngle + segAngle / 2) * Math.PI / 180;
            const x = cx + 186 * Math.cos(angle);
            const y = cy + 186 * Math.sin(angle) + 5;
            html += `<text x="${x}" y="${y}" class="dartboard-number" text-anchor="middle">${num}</text>`;
        });

        svg.innerHTML = html;
        svg.querySelectorAll('.dartboard-segment').forEach(seg => {
            seg.addEventListener('click', (e) => clickHandler(e.target));
        });
    }

    function segment(cx, cy, r1, r2, a1, a2, fill, value, mult) {
        const rad1 = a1 * Math.PI / 180;
        const rad2 = a2 * Math.PI / 180;
        const x1 = cx + r1 * Math.cos(rad1), y1 = cy + r1 * Math.sin(rad1);
        const x2 = cx + r2 * Math.cos(rad1), y2 = cy + r2 * Math.sin(rad1);
        const x3 = cx + r2 * Math.cos(rad2), y3 = cy + r2 * Math.sin(rad2);
        const x4 = cx + r1 * Math.cos(rad2), y4 = cy + r1 * Math.sin(rad2);
        const d = `M${x1},${y1} L${x2},${y2} A${r2},${r2} 0 0 1 ${x3},${y3} L${x4},${y4} A${r1},${r1} 0 0 0 ${x1},${y1}Z`;
        return `<path d="${d}" class="dartboard-segment" fill="${fill}" data-value="${value}" data-mult="${mult}"/>`;
    }

    // ===== MAGNIFIER =====
    function initMagnifier() {
        app.isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        // Update hint text based on device
        const hint = document.getElementById('magnifierHint');
        if (hint) {
            hint.textContent = app.isMobile ? 'Press & hold for magnifier' : 'Hold Ctrl for magnifier';
        }

        // Desktop: Listen for Ctrl key
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Control') {
                app.ctrlPressed = true;
            }
        });
        window.addEventListener('keyup', (e) => {
            if (e.key === 'Control') {
                app.ctrlPressed = false;
                hideMagnifier();
            }
        });
    }

    function getSvgCoords(svg, clientX, clientY) {
        if (!svg) return { x: 200, y: 200 };
        const rect = svg.getBoundingClientRect();
        const x = ((clientX - rect.left) / rect.width) * 400;
        const y = ((clientY - rect.top) / rect.height) * 400;
        return { x, y };
    }

    function getHitFromCoords(x, y) {
        const cx = 200, cy = 200;
        const dx = x - cx, dy = y - cy;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist <= 7) return { value: 25, mult: 2, label: 'BULL', score: 50, type: 'bull' }; // Bullseye
        if (dist <= 16) return { value: 25, mult: 1, label: '25', score: 25, type: 'outer-bull' }; // Outer bull
        if (dist > 175) return null; // Outside board

        // Calculate angle and find segment
        let angle = Math.atan2(dy, dx) * 180 / Math.PI + 99;
        if (angle < 0) angle += 360;
        const segmentIndex = Math.floor(angle / 18) % 20;
        const value = BOARD_ORDER[segmentIndex];

        // Determine multiplier by distance
        let mult = 1;
        let prefix = 'S';
        let type = 'single';
        if (dist >= 160 && dist <= 170) { mult = 2; prefix = 'D'; type = 'double'; } // Double
        else if (dist >= 99 && dist <= 107) { mult = 3; prefix = 'T'; type = 'treble'; } // Triple

        return {
            value,
            mult,
            label: prefix + value,
            score: value * mult,
            type
        };
    }

    function showMagnifier(screenX, screenY, svgX, svgY) {
        const loupe = document.getElementById('magnifierLoupe');
        const magnifierSvg = document.getElementById('magnifierSvg');
        const info = document.getElementById('magnifierInfo');

        app.magnifier.active = true;
        app.magnifier.x = screenX;
        app.magnifier.y = screenY;
        app.magnifier.svgX = svgX;
        app.magnifier.svgY = svgY;

        // Position the loupe (offset up on mobile so finger doesn't block it)
        const offsetY = app.isMobile ? -80 : 0;
        loupe.style.left = (screenX - 70) + 'px';
        loupe.style.top = (screenY - 70 + offsetY) + 'px';
        loupe.classList.add('active');

        // Update magnifier SVG viewBox to show zoomed area
        const viewSize = 70;
        magnifierSvg.setAttribute('viewBox', `${svgX - viewSize/2} ${svgY - viewSize/2} ${viewSize} ${viewSize}`);

        // Generate mini dartboard in magnifier
        renderMagnifierBoard(magnifierSvg, svgX, svgY);

        // Update info label with color coding
        const hit = getHitFromCoords(svgX, svgY);
        info.className = 'magnifier-info'; // Reset classes
        if (hit) {
            info.textContent = `${hit.label} = ${hit.score}`;
            info.classList.add(hit.type);
        } else {
            info.textContent = 'MISS';
            info.classList.add('miss');
        }
    }

    function hideMagnifier() {
        app.magnifier.active = false;
        document.getElementById('magnifierLoupe').classList.remove('active');
    }

    function renderMagnifierBoard(svg, crossX, crossY) {
        const cx = 200, cy = 200;
        const r = { dblOut: 170, dblIn: 160, trbOut: 107, trbIn: 99, bullOut: 16, bullIn: 7 };
        const segAngle = 18;
        const startAngle = -99;

        let html = `<circle cx="${cx}" cy="${cy}" r="175" fill="#1a1a1a"/>`;

        BOARD_ORDER.forEach((num, i) => {
            const a1 = startAngle + i * segAngle;
            const a2 = startAngle + (i + 1) * segAngle;
            const isEven = i % 2 === 0;

            html += miniSegment(cx, cy, r.dblIn, r.trbOut, a1, a2, isEven ? '#1a1a1a' : '#f5f0dc');
            html += miniSegment(cx, cy, r.trbIn, r.bullOut, a1, a2, isEven ? '#1a1a1a' : '#f5f0dc');
            html += miniSegment(cx, cy, r.dblOut, r.dblIn, a1, a2, isEven ? '#e23636' : '#208b3a');
            html += miniSegment(cx, cy, r.trbOut, r.trbIn, a1, a2, isEven ? '#e23636' : '#208b3a');
        });

        html += `<circle cx="${cx}" cy="${cy}" r="${r.bullOut}" fill="#208b3a"/>`;
        html += `<circle cx="${cx}" cy="${cy}" r="${r.bullIn}" fill="#e23636"/>`;

        // Wire rings
        const wireColor = '#888';
        html += `<circle cx="${cx}" cy="${cy}" r="${r.dblOut}" fill="none" stroke="${wireColor}" stroke-width="0.5"/>`;
        html += `<circle cx="${cx}" cy="${cy}" r="${r.dblIn}" fill="none" stroke="${wireColor}" stroke-width="0.5"/>`;
        html += `<circle cx="${cx}" cy="${cy}" r="${r.trbOut}" fill="none" stroke="${wireColor}" stroke-width="0.5"/>`;
        html += `<circle cx="${cx}" cy="${cy}" r="${r.trbIn}" fill="none" stroke="${wireColor}" stroke-width="0.5"/>`;
        html += `<circle cx="${cx}" cy="${cy}" r="${r.bullOut}" fill="none" stroke="${wireColor}" stroke-width="0.5"/>`;

        // Crosshair
        html += `<line x1="${crossX - 12}" y1="${crossY}" x2="${crossX + 12}" y2="${crossY}" stroke="white" stroke-width="2"/>`;
        html += `<line x1="${crossX}" y1="${crossY - 12}" x2="${crossX}" y2="${crossY + 12}" stroke="white" stroke-width="2"/>`;
        html += `<circle cx="${crossX}" cy="${crossY}" r="4" fill="var(--theme-primary)" stroke="white" stroke-width="1"/>`;

        svg.innerHTML = html;
    }

    function miniSegment(cx, cy, r1, r2, a1, a2, fill) {
        const rad1 = a1 * Math.PI / 180;
        const rad2 = a2 * Math.PI / 180;
        const x1 = cx + r1 * Math.cos(rad1), y1 = cy + r1 * Math.sin(rad1);
        const x2 = cx + r2 * Math.cos(rad1), y2 = cy + r2 * Math.sin(rad1);
        const x3 = cx + r2 * Math.cos(rad2), y3 = cy + r2 * Math.sin(rad2);
        const x4 = cx + r1 * Math.cos(rad2), y4 = cy + r1 * Math.sin(rad2);
        const d = `M${x1},${y1} L${x2},${y2} A${r2},${r2} 0 0 1 ${x3},${y3} L${x4},${y4} A${r1},${r1} 0 0 0 ${x1},${y1}Z`;
        return `<path d="${d}" fill="${fill}" stroke="#333" stroke-width="0.3"/>`;
    }

    function setupDartboardMagnifier(svgId, hitCallback) {
        const svg = document.getElementById(svgId);
        if (!svg) return;

        // Mouse move for desktop magnifier (Ctrl held)
        svg.addEventListener('mousemove', (e) => {
            if (app.ctrlPressed) {
                const { x, y } = getSvgCoords(svg, e.clientX, e.clientY);
                showMagnifier(e.clientX, e.clientY, x, y);
                app.magnifier.targetSvg = svg;
                e.preventDefault();
            }
        });

        // Mouse leave - hide magnifier
        svg.addEventListener('mouseleave', () => {
            if (app.magnifier.active && !app.isMobile) {
                hideMagnifier();
            }
        });

        // Click with magnifier active - use magnifier coords
        svg.addEventListener('click', (e) => {
            if (app.magnifier.active && app.ctrlPressed) {
                const hit = getHitFromCoords(app.magnifier.svgX, app.magnifier.svgY);
                if (hit) {
                    // Create a fake segment element with the data attributes
                    const fakeSeg = { dataset: { value: hit.value, mult: hit.mult } };
                    hitCallback(fakeSeg);
                }
                e.preventDefault();
                e.stopPropagation();
            }
        }, true); // Use capture to intercept before segment click

        // Touch start - start long press timer
        svg.addEventListener('touchstart', (e) => {
            app.touchStartTime = Date.now();
            if (app.isMobile) {
                const touch = e.touches[0];
                app.longPressTimer = setTimeout(() => {
                    const { x, y } = getSvgCoords(svg, touch.clientX, touch.clientY);
                    showMagnifier(touch.clientX, touch.clientY, x, y);
                    app.magnifier.targetSvg = svg;
                    haptic();
                }, 300);
            }
        }, { passive: true });

        // Touch move - update magnifier or cancel long press
        svg.addEventListener('touchmove', (e) => {
            if (app.longPressTimer && !app.magnifier.active) {
                clearTimeout(app.longPressTimer);
                app.longPressTimer = null;
            }
            if (app.magnifier.active && app.isMobile) {
                const touch = e.touches[0];
                const { x, y } = getSvgCoords(svg, touch.clientX, touch.clientY);
                showMagnifier(touch.clientX, touch.clientY, x, y);
                e.preventDefault();
            }
        }, { passive: false });

        // Touch end - either hit with magnifier or normal tap
        svg.addEventListener('touchend', (e) => {
            if (app.longPressTimer) {
                clearTimeout(app.longPressTimer);
                app.longPressTimer = null;
            }

            const touchDuration = Date.now() - app.touchStartTime;

            if (app.magnifier.active) {
                // Magnifier was active - hit where the crosshair is
                const hit = getHitFromCoords(app.magnifier.svgX, app.magnifier.svgY);
                if (hit) {
                    const fakeSeg = { dataset: { value: hit.value, mult: hit.mult } };
                    hitCallback(fakeSeg);
                }
                hideMagnifier();
                e.preventDefault();
            }
            // If it was a quick tap (< 300ms), let the normal click handler work
        });
    }

    // ===== INPUT GRIDS =====
    function generateDartsGrid() {
        const grid = document.getElementById('dartsGrid');
        let html = '';
        for (let i = 1; i <= 20; i++) {
            html += `<button class="dart-btn" data-num="${i}">${i}</button>`;
        }
        html += `<button class="dart-btn special" data-num="25">25</button>`;
        html += `<button class="dart-btn special" data-num="50">BULL</button>`;
        html += `<button class="dart-btn miss" data-num="0">MISS</button>`;
        grid.innerHTML = html;
    }

    function generateQuickGrid() {
        // Common 3-dart turn totals (all valid)
        const scores = [
            { v: 0, l: 'MISS', c: 'miss' },
            { v: 26, l: '26' },
            { v: 41, l: '41' },
            { v: 45, l: '45' },
            { v: 60, l: '60', c: 'ton' },
            { v: 81, l: '81' },
            { v: 85, l: '85' },
            { v: 95, l: '95' },
            { v: 100, l: '100', c: 'ton' },
            { v: 120, l: '120', c: 'ton' },
            { v: 140, l: '140', c: 'highlight' },
            { v: 180, l: '180', c: 'highlight' }
        ];
        const grid = document.getElementById('quickGrid');
        grid.innerHTML = scores.map(s => 
            `<button class="quick-btn ${s.c || ''}" data-score="${s.v}">${s.l}</button>`
        ).join('');
    }

    function generateNumpad() {
        const grid = document.getElementById('numpadGrid');
        let html = '';
        for (let i = 1; i <= 9; i++) html += `<button class="num-btn" data-key="${i}">${i}</button>`;
        html += `<button class="num-btn secondary" data-key="clear">C</button>`;
        html += `<button class="num-btn" data-key="0">0</button>`;
        html += `<button class="num-btn action" data-key="enter">âœ“</button>`;
        grid.innerHTML = html;
    }

    // Generate fullscreen input grids
    function generateFsInputs() {
        // Darts grid
        const dartsGrid = document.getElementById('fsDartsGrid');
        let dartsHtml = '';
        for (let i = 1; i <= 20; i++) {
            dartsHtml += `<button class="fs-dart-btn" data-num="${i}">${i}</button>`;
        }
        dartsHtml += `<button class="fs-dart-btn special" data-num="25">25</button>`;
        dartsHtml += `<button class="fs-dart-btn special" data-num="50">BULL</button>`;
        dartsHtml += `<button class="fs-dart-btn miss" data-num="0">MISS</button>`;
        dartsGrid.innerHTML = dartsHtml;

        // Quick grid
        const quickScores = [
            { v: 0, l: 'MISS', c: 'miss' },
            { v: 26, l: '26' },
            { v: 41, l: '41' },
            { v: 45, l: '45' },
            { v: 60, l: '60', c: 'ton' },
            { v: 81, l: '81' },
            { v: 85, l: '85' },
            { v: 95, l: '95' },
            { v: 100, l: '100', c: 'ton' },
            { v: 120, l: '120', c: 'ton' },
            { v: 140, l: '140', c: 'highlight' },
            { v: 180, l: '180', c: 'highlight' }
        ];
        const quickGrid = document.getElementById('fsQuickGrid');
        quickGrid.innerHTML = quickScores.map(s => 
            `<button class="fs-quick-btn ${s.c || ''}" data-score="${s.v}">${s.l}</button>`
        ).join('');

        // Numpad grid
        const numpadGrid = document.getElementById('fsNumpadGrid');
        let numpadHtml = '';
        for (let i = 1; i <= 9; i++) numpadHtml += `<button class="fs-num-btn" data-key="${i}">${i}</button>`;
        numpadHtml += `<button class="fs-num-btn secondary" data-key="clear">C</button>`;
        numpadHtml += `<button class="fs-num-btn" data-key="0">0</button>`;
        numpadHtml += `<button class="fs-num-btn action" data-key="enter">âœ“</button>`;
        numpadGrid.innerHTML = numpadHtml;
    }

    function generateCheckoutChart() {
        const container = document.getElementById('checkoutChart');
        let html = '<div class="section-title">ðŸ“‹ PDC Checkout Chart</div>';
        
        // Group by range
        const ranges = [
            { name: '3-Dart Finishes (161-170)', start: 161, end: 170 },
            { name: '2-Dart Possible (100-160)', start: 100, end: 160 },
            { name: '2-Dart Finishes (61-99)', start: 61, end: 99 },
            { name: '1-Dart Possible (2-60)', start: 2, end: 60 }
        ];

        ranges.forEach(range => {
            html += `<div class="checkout-section-title">${range.name}</div>`;
            html += '<div class="checkout-grid">';
            for (let i = range.end; i >= range.start; i--) {
                if (CHECKOUTS[i]) {
                    const co = CHECKOUTS[i];
                    html += `<div class="checkout-item">
                        <span class="checkout-num">${i}</span>
                        <span class="checkout-route">${co.primary}</span>
                    </div>`;
                }
            }
            html += '</div>';
        });
        
        container.innerHTML = html;
    }

    // ===== PLAYERS =====
    function renderPlayers() {
        const list = document.getElementById('playersList');
        list.innerHTML = app.setup.players.map((name, i) => `
            <div class="player-row">
                <input type="text" value="${name}" data-idx="${i}" placeholder="Player ${i+1}">
                ${i > 0 ? `<button class="remove-btn" data-idx="${i}">âœ•</button>` : ''}
            </div>
        `).join('');

        list.querySelectorAll('input').forEach(inp => {
            inp.addEventListener('input', e => {
                app.setup.players[+e.target.dataset.idx] = e.target.value || `Player ${+e.target.dataset.idx + 1}`;
            });
            // Save when user finishes editing (blur)
            inp.addEventListener('blur', saveData);
        });

        list.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                app.setup.players.splice(+e.target.dataset.idx, 1);
                renderPlayers();
                saveData();
            });
        });
    }

    // Apply saved setup to UI
    function applySetup() {
        // Game type
        document.querySelectorAll('#gameTypeOpts .option-btn').forEach(b => {
            b.classList.toggle('selected', +b.dataset.val === app.setup.type);
        });
        // Out mode
        document.querySelectorAll('#outModeOpts .option-btn').forEach(b => {
            b.classList.toggle('selected', b.dataset.val === app.setup.out);
        });
        // Legs
        document.querySelectorAll('#legsOpts .option-btn').forEach(b => {
            b.classList.toggle('selected', +b.dataset.val === app.setup.legs);
        });
        // Sets
        document.querySelectorAll('#setsOpts .option-btn').forEach(b => {
            b.classList.toggle('selected', +b.dataset.val === app.setup.sets);
        });
        // First throw
        document.querySelectorAll('#firstThrowOpts .option-btn').forEach(b => {
            b.classList.toggle('selected', b.dataset.val === app.setup.firstThrow);
        });
    }

    // ===== GAME =====
    function startGame() {
        // Check if we need to determine first thrower
        if (app.setup.firstThrow === 'coin') {
            openCoinToss();
            return;
        } else if (app.setup.firstThrow === 'bull') {
            openNearestBull();
            return;
        }

        // Start with player 1 (index 0)
        initializeGame(0);
    }

    function initializeGame(startingPlayerIndex) {
        app.game = {
            type: app.setup.type,
            out: app.setup.out,
            legsToWin: app.setup.legs,
            setsToWin: app.setup.sets,
            players: app.setup.players.map(name => ({
                name,
                score: app.setup.type,
                legs: 0,
                sets: 0,
                darts: 0,
                dartsThisLeg: 0,
                totalScore: 0,
                legScore: 0,
                tons: 0,
                ton40s: 0,
                one80s: 0,
                first9Score: 0,
                checkoutAtt: 0,
                checkoutHit: 0
            })),
            current: startingPlayerIndex,
            throws: [],
            leg: 1,
            set: 1,
            history: [],
            startingPlayer: startingPlayerIndex
        };

        updateGameUI();
        navigate('game');

        // Auto-fullscreen on mobile/small screens
        if (app.settings.autoFullscreen && window.innerHeight < 700) {
            setTimeout(openFullscreen, 100);
        }
    }

    // ===== COIN TOSS =====
    function openCoinToss() {
        app.coinToss = {
            playerChoice: null,
            result: null,
            winner: null
        };

        // Reset UI
        document.getElementById('coin').className = 'coin';
        document.getElementById('coinResult').textContent = '';
        document.getElementById('coinWinner').textContent = `${app.setup.players[0]}, pick heads or tails:`;
        document.getElementById('coinStartBtn').style.display = 'none';
        document.getElementById('coinHeadsBtn').style.display = '';
        document.getElementById('coinTailsBtn').style.display = '';

        document.getElementById('coinTossModal').classList.add('open');
    }

    function flipCoin(playerChoice) {
        if (app.coinToss.result !== null) return; // Already flipped

        app.coinToss.playerChoice = playerChoice;

        // Hide choice buttons
        document.getElementById('coinHeadsBtn').style.display = 'none';
        document.getElementById('coinTailsBtn').style.display = 'none';
        document.getElementById('coinWinner').textContent = 'Flipping...';

        // Random result
        const result = Math.random() < 0.5 ? 'heads' : 'tails';
        app.coinToss.result = result;

        // Animate coin
        const coin = document.getElementById('coin');
        coin.className = 'coin flipping' + (result === 'tails' ? ' to-tails' : '');

        haptic();

        // Show result after animation
        setTimeout(() => {
            document.getElementById('coinResult').textContent = result.toUpperCase() + '!';

            // Determine winner
            const p1Won = (playerChoice === result);
            app.coinToss.winner = p1Won ? 0 : 1;

            const winnerName = app.setup.players[app.coinToss.winner];
            document.getElementById('coinWinner').textContent = `${winnerName} throws first!`;
            document.getElementById('coinStartBtn').style.display = '';
        }, 2000);
    }

    function closeCoinToss() {
        document.getElementById('coinTossModal').classList.remove('open');
        if (app.coinToss && app.coinToss.winner !== null) {
            initializeGame(app.coinToss.winner);
        }
        app.coinToss = null;
    }

    // ===== NEAREST BULL =====
    function openNearestBull() {
        app.nearestBull = {
            currentPlayer: 0,
            throws: [], // Array of {playerIndex, value, mult, distance}
            winner: null
        };

        updateNearestBullUI();
        document.getElementById('nearestBullModal').classList.add('open');
    }

    function updateNearestBullUI() {
        const nb = app.nearestBull;
        if (!nb) return;

        const playerName = app.setup.players[nb.currentPlayer];
        document.getElementById('bullCurrentPlayer').textContent = playerName;

        // Show throws
        const throwsHtml = nb.throws.map(t => {
            const isWinner = nb.winner !== null && t.playerIndex === nb.winner;
            return `<div class="bull-throw-item ${isWinner ? 'winner' : ''}">${app.setup.players[t.playerIndex]}: ${t.label}</div>`;
        }).join('');
        document.getElementById('bullThrows').innerHTML = throwsHtml;

        // Show winner or instruction
        if (nb.winner !== null) {
            document.getElementById('bullInstruction').style.display = 'none';
            document.getElementById('bullWinner').textContent = `${app.setup.players[nb.winner]} throws first!`;
            document.getElementById('bullStartBtn').style.display = '';
        } else {
            document.getElementById('bullInstruction').style.display = '';
            document.getElementById('bullWinner').textContent = '';
            document.getElementById('bullStartBtn').style.display = 'none';
        }
    }

    function handleBullThrow(seg) {
        const nb = app.nearestBull;
        if (!nb || nb.winner !== null) return;

        const value = +seg.dataset.value;
        const mult = +seg.dataset.mult;

        // Calculate distance from bull (25 is bull center)
        // Bull = 0, 25 outer = 1, then by segment number distance
        let distance;
        let label;

        if (value === 25 && mult === 2) {
            distance = 0; // Bullseye
            label = 'BULL';
        } else if (value === 25 && mult === 1) {
            distance = 1; // Outer bull
            label = '25';
        } else {
            // Other segments - higher number = further from bull conceptually
            // Use a simple scoring: single = value, double = value, treble = value
            // But for distance, we'll use board position
            distance = 2 + (20 - value); // Closer to 20 = better
            const prefix = mult === 3 ? 'T' : mult === 2 ? 'D' : '';
            label = prefix + value;
        }

        nb.throws.push({
            playerIndex: nb.currentPlayer,
            value,
            mult,
            distance,
            label
        });

        haptic();

        // Move to next player
        nb.currentPlayer++;

        // Check if all players have thrown
        if (nb.currentPlayer >= app.setup.players.length) {
            // Determine winner (lowest distance)
            let minDistance = Infinity;
            let winnerIndex = 0;
            nb.throws.forEach(t => {
                if (t.distance < minDistance) {
                    minDistance = t.distance;
                    winnerIndex = t.playerIndex;
                }
            });
            nb.winner = winnerIndex;
        }

        updateNearestBullUI();
    }

    function closeNearestBull() {
        document.getElementById('nearestBullModal').classList.remove('open');
        if (app.nearestBull && app.nearestBull.winner !== null) {
            initializeGame(app.nearestBull.winner);
        }
        app.nearestBull = null;
    }

    function updateGameUI() {
        const g = app.game;
        if (!g) return;
        
        // Score bar
        document.getElementById('scoreBar').innerHTML = g.players.map((p, i) => {
            const avg = p.darts > 0 ? ((p.totalScore / p.darts) * 3).toFixed(2) : '0.00';
            return `
            <div class="player-card player-${i % 4} ${i === g.current ? 'active' : ''}">
                <div class="player-name">${p.name}</div>
                <div class="player-score-main">${p.score}</div>
                <div class="player-avg">Avg: ${avg}</div>
                <div class="player-legs">${p.sets > 0 ? `S${p.sets} ` : ''}L${p.legs}</div>
            </div>
        `}).join('');
        
        // Game info
        document.getElementById('gameBadge').textContent = g.type;
        const matchText = g.setsToWin > 1 
            ? `Set ${g.set} â€¢ Leg ${g.leg}` 
            : `Leg ${g.leg} of ${g.legsToWin * 2 - 1}`;
        document.getElementById('matchInfo').textContent = matchText;
        
        // Match stats (current player)
        const cp = g.players[g.current];
        document.getElementById('msTons').textContent = cp.tons;
        document.getElementById('ms140').textContent = cp.ton40s;
        document.getElementById('ms180').textContent = cp.one80s;
        const first9Avg = cp.dartsThisLeg >= 9 && cp.first9Score > 0 
            ? (cp.first9Score / 9 * 3).toFixed(1) 
            : '-';
        document.getElementById('msFirst9').textContent = first9Avg;
        
        // Turn display
        updateTurnDisplay();
        
        // Checkout hint
        updateCheckoutHint();
        
        // Fullscreen UI
        if (app.fullscreen) {
            updateFullscreenUI();
        }
    }

    function updateTurnDisplay() {
        const g = app.game;
        
        // Check if current throws are a turn total
        const isTurnTotal = g.throws.length > 0 && g.throws[0].isTurnTotal;
        
        for (let i = 0; i < 3; i++) {
            const slot = document.getElementById(`dart${i}`);
            if (isTurnTotal) {
                // Show turn total across all 3 slots
                if (i === 1) {
                    slot.textContent = g.throws[0].score;
                    slot.className = 'dart-slot filled';
                } else {
                    slot.textContent = 'â€¢';
                    slot.className = 'dart-slot filled';
                }
            } else if (g.throws[i]) {
                slot.textContent = formatThrow(g.throws[i]);
                slot.className = 'dart-slot filled';
            } else {
                slot.textContent = '-';
                slot.className = `dart-slot ${i === g.throws.length ? 'current' : ''}`;
            }
        }
        
        const total = isTurnTotal ? g.throws[0].score : g.throws.reduce((sum, t) => sum + t.score, 0);
        document.getElementById('turnTotal').textContent = total;
    }

    function updateCheckoutHint() {
        const g = app.game;
        const remaining = g.players[g.current].score;
        const hint = document.getElementById('checkoutHint');
        const path = document.getElementById('checkoutPath');
        const alt = document.getElementById('checkoutAlt');
        const altRow = document.getElementById('checkoutAltRow');
        const continueRow = document.getElementById('checkoutContinue');
        const continuePath = document.getElementById('checkoutContinuePath');
        
        // Reset continue row
        continueRow.style.display = 'none';
        altRow.style.display = 'none';
        
        // No checkout available
        if (remaining > 170 || remaining < 2 || !CHECKOUTS[remaining]) {
            hint.classList.add('hidden');
            app.turnCheckout = null;
            return;
        }
        
        hint.classList.remove('hidden');
        
        // Get route based on preference
        const route = getCheckoutRoute(remaining, app.settings.checkoutPref);
        
        // If we have a tracked checkout route from earlier in the turn, check continuity
        if (app.turnCheckout && g.throws.length > 0) {
            const parsedOriginal = parseCheckoutRoute(app.turnCheckout.route);
            const dartsUsed = g.throws.length;
            
            // Check if all throws so far matched the original route
            let matched = true;
            for (let i = 0; i < dartsUsed && i < parsedOriginal.length; i++) {
                if (!throwMatchesRoute(g.throws[i], parsedOriginal[i])) {
                    matched = false;
                    break;
                }
            }
            
            if (matched && dartsUsed < parsedOriginal.length) {
                // Player is following the route - show remaining darts
                const remainingDarts = parsedOriginal.slice(dartsUsed);
                const continueStr = remainingDarts.map(d => d.str).join(' ');
                
                continueRow.style.display = 'flex';
                continuePath.textContent = continueStr;
            }
        }
        
        // At start of turn (no throws), set the checkout route to track
        if (g.throws.length === 0) {
            app.turnCheckout = {
                score: remaining,
                route: route.primary
            };
        }
        
        // Show main route
        path.textContent = route.primary;
        
        // Show alternative if available
        if (route.alt && route.alt.length > 0 && route.alt[0] !== route.primary) {
            altRow.style.display = 'flex';
            alt.textContent = route.alt[0];
        }
    }

    function formatThrow(t) {
        if (t.score === 0) return 'M';
        if (t.value === 25 && t.mult === 2) return 'Bull';
        if (t.value === 25) return '25';
        const prefix = t.mult === 3 ? 'T' : t.mult === 2 ? 'D' : '';
        return prefix + t.value;
    }

    function handleGameThrow(seg) {
        if (!app.game) return;
        
        // Check if 3 darts already thrown
        if (app.game.throws.length >= 3) {
            toast('Turn complete - tap Next', 'error');
            return;
        }
        
        // Check if turn total was already entered
        if (app.game.throws.length > 0 && app.game.throws[0].isTurnTotal) {
            toast('Turn complete - tap Next', 'error');
            return;
        }
        
        const value = +seg.dataset.value;
        const mult = +seg.dataset.mult;
        const score = value * mult;
        
        recordThrow(value, mult, score);
    }

    function recordThrow(value, mult, score) {
        const g = app.game;
        const player = g.players[g.current];
        const newScore = player.score - score;
        
        // Validate dart
        if (!isValidDartScore(value, mult)) {
            toast('Invalid dart!', 'error');
            return;
        }
        
        // Track checkout attempts
        if (player.score <= 170 && CHECKOUTS[player.score] && mult === 2) {
            player.checkoutAtt++;
            app.stats.checkoutAtt++;
        }
        
        // Bust check
        if (newScore < 0 || newScore === 1 ||
            (newScore === 0 && g.out === 'double' && mult !== 2) ||
            (newScore === 0 && g.out === 'master' && mult === 1)) {
            toast('BUST!', 'error');
            haptic();
            bustTurn();
            return;
        }
        
        // Record throw
        g.throws.push({ value, mult, score });
        g.history.push({ player: g.current, throw: { value, mult, score }, scoreBefore: player.score });
        
        player.score = newScore;
        player.darts++;
        player.dartsThisLeg++;
        player.totalScore += score;
        player.legScore += score;
        
        // First 9 tracking
        if (player.dartsThisLeg <= 9) {
            player.first9Score += score;
        }
        
        app.stats.darts++;
        app.stats.score += score;
        
        haptic();
        
        // Check turn total for ton+ (after 3 darts or checkout)
        if (g.throws.length === 3 || newScore === 0) {
            const turnTotal = g.throws.reduce((s, t) => s + t.score, 0);
            if (turnTotal >= 180) {
                toast('180! ðŸŽ¯', 'success');
                player.one80s++;
                app.stats.one80s++;
            } else if (turnTotal >= 140) {
                player.ton40s++;
                app.stats.ton40s++;
            } else if (turnTotal >= 100) {
                player.tons++;
                app.stats.tons++;
            }
        }
        
        // Check win
        if (newScore === 0) {
            player.checkoutHit++;
            app.stats.checkoutHit++;
            const checkout = g.throws.reduce((s, t) => s + t.score, 0);
            if (checkout > app.stats.highCo) app.stats.highCo = checkout;
            legWon();
            return;
        }
        
        updateGameUI();
        
        // Auto-next after 3 darts
        if (g.throws.length >= 3) {
            setTimeout(nextPlayer, 400);
        }
    }

    // Record a full turn score (for QUICK and NUMPAD input)
    // This counts as 3 darts thrown at once
    function recordTurn(turnScore) {
        const g = app.game;
        const player = g.players[g.current];
        
        // Validate turn score
        if (!isValidTurnScore(turnScore)) {
            toast(`Invalid score! ${IMPOSSIBLE_SCORES.includes(turnScore) ? 'Impossible with 3 darts' : 'Max is 180'}`, 'error');
            return;
        }
        
        // Check if there are already darts thrown this turn
        if (g.throws.length > 0) {
            toast('Finish current turn first!', 'error');
            return;
        }
        
        const newScore = player.score - turnScore;
        
        // For turn scores, we can't validate checkout properly since we don't know individual darts
        // But we can check basic bust rules
        if (newScore < 0) {
            toast('BUST! Score too high', 'error');
            haptic();
            nextPlayer();
            return;
        }
        
        if (newScore === 1) {
            toast('BUST! Cannot leave 1', 'error');
            haptic();
            nextPlayer();
            return;
        }
        
        // For double-out, if score goes to exactly 0, we assume they hit the double
        // (trust the user since they're entering turn totals)
        if (newScore === 0 && g.out === 'double') {
            // Valid checkout - they must have hit a double to finish
        }
        
        // Record as 3 darts (we create synthetic throws for history)
        const syntheticThrow = { value: turnScore, mult: 1, score: turnScore, isTurnTotal: true };
        g.throws = [syntheticThrow, syntheticThrow, syntheticThrow]; // Fill all 3 slots
        g.history.push({ 
            player: g.current, 
            throw: syntheticThrow, 
            scoreBefore: player.score,
            turnTotal: turnScore,
            dartsThrown: 3
        });
        
        // Update player stats (3 darts at once)
        player.score = newScore;
        player.darts += 3;
        player.dartsThisLeg += 3;
        player.totalScore += turnScore;
        player.legScore += turnScore;
        
        // First 9 tracking (3 darts at a time)
        if (player.dartsThisLeg <= 9) {
            player.first9Score += turnScore;
        }
        
        // Global stats
        app.stats.darts += 3;
        app.stats.score += turnScore;
        
        haptic();
        
        // Ton tracking
        if (turnScore >= 180) {
            toast('180! ðŸŽ¯', 'success');
            player.one80s++;
            app.stats.one80s++;
        } else if (turnScore >= 140) {
            player.ton40s++;
            app.stats.ton40s++;
        } else if (turnScore >= 100) {
            player.tons++;
            app.stats.tons++;
        }
        
        // Check win
        if (newScore === 0) {
            player.checkoutHit++;
            app.stats.checkoutHit++;
            if (turnScore > app.stats.highCo) app.stats.highCo = turnScore;
            legWon();
            return;
        }
        
        updateGameUI();
        
        // Auto advance to next player
        setTimeout(nextPlayer, 400);
    }

    function bustTurn() {
        const g = app.game;
        const player = g.players[g.current];
        
        // Restore score and stats
        g.throws.forEach(t => {
            player.score += t.score;
            player.totalScore -= t.score;
            player.legScore -= t.score;
            if (player.dartsThisLeg <= 9 + g.throws.length) {
                player.first9Score -= t.score;
            }
            app.stats.score -= t.score;
        });
        
        // Darts still count
        g.throws = [];
        setTimeout(nextPlayer, 300);
    }

    function nextPlayer() {
        const g = app.game;
        g.throws = [];
        g.current = (g.current + 1) % g.players.length;
        app.turnCheckout = null; // Reset checkout tracking for new turn
        updateGameUI();
    }

    function legWon() {
        const g = app.game;
        const winner = g.players[g.current];
        
        // Track first 9 average for the leg
        if (winner.dartsThisLeg >= 9) {
            app.stats.first9Total += winner.first9Score;
            app.stats.first9Legs++;
        }
        
        winner.legs++;
        
        if (winner.legs >= g.legsToWin) {
            if (g.setsToWin > 1) {
                winner.sets++;
                if (winner.sets >= g.setsToWin) {
                    gameWon(winner);
                    return;
                }
                g.players.forEach(p => p.legs = 0);
                g.set++;
                g.leg = 1;
            } else {
                gameWon(winner);
                return;
            }
        } else {
            g.leg++;
        }
        
        // Reset for new leg
        g.players.forEach(p => {
            p.score = g.type;
            p.dartsThisLeg = 0;
            p.first9Score = 0;
            p.legScore = 0;
        });
        g.throws = [];
        
        // Alternate starting player
        g.startingPlayer = (g.startingPlayer + 1) % g.players.length;
        g.current = g.startingPlayer;
        
        toast(`${winner.name} wins leg ${g.leg - 1}!`, 'success');
        updateGameUI();
    }

    function gameWon(winner) {
        const g = app.game;
        app.stats.games++;
        app.stats.wins++;
        saveData();
        
        const avg = winner.darts > 0 ? ((winner.totalScore / winner.darts) * 3).toFixed(2) : '0.00';
        const lastCheckout = g.throws.reduce((s, t) => s + t.score, 0);
        
        document.getElementById('winnerName').textContent = `${winner.name} Wins!`;
        document.getElementById('winnerAvg').textContent = avg;
        document.getElementById('winnerCheckout').textContent = lastCheckout;
        document.getElementById('winnerDarts').textContent = winner.darts;
        
        // Close fullscreen first, then show modal
        closeFullscreen();
        
        // Small delay to ensure fullscreen is closed
        setTimeout(() => {
            document.getElementById('gameOverModal').classList.add('open');
        }, 100);
        
        app.game = null;
    }

    function undoThrow() {
        const g = app.game;
        if (!g || g.history.length === 0) {
            toast('Nothing to undo', 'error');
            return;
        }
        
        const last = g.history.pop();
        const player = g.players[last.player];
        
        // Check if this was a turn total (QUICK/NUMPAD input)
        if (last.turnTotal !== undefined) {
            // Undo entire turn (3 darts)
            player.score = last.scoreBefore;
            player.darts -= 3;
            player.dartsThisLeg -= 3;
            player.totalScore -= last.turnTotal;
            player.legScore -= last.turnTotal;
            
            if (player.dartsThisLeg < 9) {
                player.first9Score -= last.turnTotal;
            }
            
            app.stats.darts -= 3;
            app.stats.score -= last.turnTotal;
            
            // Reset throws for this turn
            g.current = last.player;
            g.throws = [];
        } else {
            // Regular single dart undo
            player.score = last.scoreBefore;
            player.darts--;
            player.dartsThisLeg--;
            player.totalScore -= last.throw.score;
            player.legScore -= last.throw.score;
            
            if (player.dartsThisLeg < 9) {
                player.first9Score -= last.throw.score;
            }
            
            app.stats.darts--;
            app.stats.score -= last.throw.score;
            
            if (last.player === g.current && g.throws.length > 0) {
                g.throws.pop();
            } else {
                g.current = last.player;
                // Rebuild throws for this player's current turn
                g.throws = [];
                for (let i = g.history.length - 1; i >= 0; i--) {
                    if (g.history[i].player === last.player && !g.history[i].turnTotal) {
                        g.throws.unshift(g.history[i].throw);
                        if (g.throws.length >= 3) break;
                    } else {
                        break;
                    }
                }
            }
        }
        
        app.turnCheckout = null; // Reset checkout tracking
        updateGameUI();
    }

    // ===== FULLSCREEN =====
    function openFullscreen() {
        app.fullscreen = true;
        
        // Sync input mode from regular game view
        const activeTab = document.querySelector('.input-tab.active');
        if (activeTab) {
            app.fsInputMode = activeTab.dataset.tab;
        }
        
        // Update fullscreen tabs and panels
        document.querySelectorAll('.fs-input-tab').forEach(t => 
            t.classList.toggle('active', t.dataset.fstab === app.fsInputMode));
        document.querySelectorAll('.fs-input-panel').forEach(p => 
            p.classList.toggle('active', p.id === `fs-panel-${app.fsInputMode}`));
        
        // Sync multiplier
        app.fsMultiplier = app.multiplier;
        document.querySelectorAll('.fs-mult-btn').forEach(b => 
            b.classList.toggle('active', +b.dataset.fsmult === app.fsMultiplier));
        
        // Reset numpad
        app.fsNumpadVal = '';
        const fsDisplay = document.getElementById('fsNumpadDisplay');
        if (fsDisplay) {
            fsDisplay.textContent = '-';
            fsDisplay.style.color = '';
        }
        
        document.getElementById('fullscreenOverlay').classList.add('active');
        updateFullscreenUI();
    }

    function closeFullscreen() {
        app.fullscreen = false;
        document.getElementById('fullscreenOverlay').classList.remove('active');
    }

    function updateFullscreenUI() {
        const g = app.game;
        if (!g) return;
        
        // Match info
        const matchText = g.setsToWin > 1 
            ? `${g.type} â€¢ Set ${g.set} Leg ${g.leg}` 
            : `${g.type} â€¢ Leg ${g.leg}`;
        document.getElementById('fsMatchInfo').textContent = matchText;
        
        // Player panels (supports 2 players in fullscreen)
        g.players.slice(0, 2).forEach((p, i) => {
            const panel = document.getElementById(`fsPlayer${i}`);
            if (!panel) return;

            // Add player color class and toggle active
            panel.className = `fs-player-panel player-${i} ${i === 1 ? 'right' : ''} ${i === g.current ? 'active' : ''}`;
            
            const avg = p.darts > 0 ? ((p.totalScore / p.darts) * 3).toFixed(1) : '0.0';
            const route = getCheckoutRoute(p.score, app.settings.checkoutPref);
            
            // Check for continuation route for current player
            let checkoutDisplay = '';
            if (route) {
                let showRoute = route.primary;
                
                // If this is the current player and they're mid-turn, check for continuation
                if (i === g.current && app.turnCheckout && g.throws.length > 0) {
                    const parsedOriginal = parseCheckoutRoute(app.turnCheckout.route);
                    let matched = true;
                    for (let j = 0; j < g.throws.length && j < parsedOriginal.length; j++) {
                        if (!throwMatchesRoute(g.throws[j], parsedOriginal[j])) {
                            matched = false;
                            break;
                        }
                    }
                    if (matched && g.throws.length < parsedOriginal.length) {
                        const remainingDarts = parsedOriginal.slice(g.throws.length);
                        showRoute = remainingDarts.map(d => d.str).join(' ');
                    }
                }
                
                checkoutDisplay = `<div class="fs-checkout">${showRoute}</div>`;
            }
            
            panel.innerHTML = `
                <div class="fs-player-name">${p.name}</div>
                <div class="fs-player-score">${p.score}</div>
                <div class="fs-player-meta">
                    <span>Avg <span class="val">${avg}</span></span>
                    <span>L<span class="val">${p.legs}</span></span>
                </div>
                ${checkoutDisplay}
            `;
        });
        
        // Darts display
        const isTurnTotal = g.throws.length > 0 && g.throws[0].isTurnTotal;
        
        for (let i = 0; i < 3; i++) {
            const slot = document.getElementById(`fsDart${i}`);
            if (isTurnTotal) {
                if (i === 1) {
                    slot.textContent = g.throws[0].score;
                    slot.className = 'fs-dart filled';
                } else {
                    slot.textContent = 'â€¢';
                    slot.className = 'fs-dart filled';
                }
            } else if (g.throws[i]) {
                slot.textContent = formatThrow(g.throws[i]);
                slot.className = 'fs-dart filled';
            } else {
                slot.textContent = '-';
                slot.className = 'fs-dart';
            }
        }
        
        const total = isTurnTotal ? g.throws[0].score : g.throws.reduce((sum, t) => sum + t.score, 0);
        document.getElementById('fsTotal').textContent = total;
    }

    // ===== PRACTICE =====
    function startPractice(mode) {
        console.log('startPractice called with mode:', mode);
        try {
            app.practice = {
                mode,
                target: null,
                hits: 0,
                darts: 0,
                score: mode === 'bob27' ? 27 : 0,
                sequence: [],
                index: 0,
                roundDarts: 0,
                roundHits: 0
            };
            
            switch (mode) {
                case 'doubles':
                    app.practice.sequence = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20].map(n => ({ value: n, mult: 2 }));
                    break;
                case 'trebles':
                    app.practice.sequence = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20].map(n => ({ value: n, mult: 3 }));
                    break;
                case 'around':
                    app.practice.sequence = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20].map(n => ({ value: n, mult: 1 }));
                    break;
                case 'checkout':
                    setRandomCheckout();
                    break;
                case 'random':
                    setRandomTarget();
                    break;
                case 'bob27':
                    app.practice.sequence = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20].map(n => ({ value: n, mult: 2 }));
                    break;
            }
            
            // Open fullscreen in practice mode
            openPracticeFullscreen();
        } catch (e) {
            console.error('startPractice error:', e);
        }
    }
    
    function openPracticeFullscreen() {
        console.log('openPracticeFullscreen called');
        try {
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.classList.add('active', 'practice-mode');
            
            // Hide game elements, show practice elements
            document.getElementById('fsPlayer1').style.display = 'none';
            document.getElementById('fsPracticePanel').style.display = 'block';
            document.getElementById('fsActions').style.display = 'none';
            document.getElementById('fsPracticeActions').style.display = 'flex';
            
            // Update player panel for practice
            const p0 = document.getElementById('fsPlayer0');
            p0.querySelector('.fs-player-name').textContent = 'PRACTICE';
            p0.querySelector('.fs-player-score').textContent = app.practice.mode === 'bob27' ? app.practice.score : app.practice.hits;
            p0.querySelector('.fs-player-meta').innerHTML = `
                <span>Hits <span class="val">${app.practice.hits}</span></span>
                <span>Darts <span class="val">${app.practice.darts}</span></span>
            `;
            
            // Update match info
            const titles = {
                'doubles': 'DOUBLES',
                'trebles': 'TREBLES', 
                'around': 'AROUND THE CLOCK',
                'checkout': 'CHECKOUTS',
                'random': 'RANDOM TARGET',
                'bob27': "BOB'S 27"
            };
            document.getElementById('fsMatchInfo').textContent = titles[app.practice.mode] || 'PRACTICE';
            
            // Clear turn display
            for (let i = 0; i < 3; i++) {
                const d = document.getElementById(`fsDart${i}`);
                d.textContent = '-';
                d.classList.remove('filled');
            }
            document.getElementById('fsTotal').textContent = '0';
            
            // Reset to board tab
            app.fsInputMode = 'board';
            document.querySelectorAll('.fs-input-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-fstab="board"]').classList.add('active');
            document.querySelectorAll('.fs-input-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('fs-panel-board').classList.add('active');
            
            updatePracticeFullscreenUI();
            console.log('openPracticeFullscreen complete');
        } catch (e) {
            console.error('openPracticeFullscreen error:', e);
        }
    }
    
    function closePracticeFullscreen() {
        const overlay = document.getElementById('fullscreenOverlay');
        overlay.classList.remove('active', 'practice-mode');
        
        // Restore game elements
        document.getElementById('fsPlayer1').style.display = '';
        document.getElementById('fsPracticePanel').style.display = 'none';
        document.getElementById('fsActions').style.display = '';
        document.getElementById('fsPracticeActions').style.display = 'none';
        
        app.practice = null;
        navigate('practice');
    }
    
    function updatePracticeFullscreenUI() {
        const p = app.practice;
        if (!p) return;
        
        const label = document.getElementById('fsPracticeLabel');
        const target = document.getElementById('fsPracticeTarget');
        const sub = document.getElementById('fsPracticeSub');
        const p0 = document.getElementById('fsPlayer0');
        
        switch (p.mode) {
            case 'doubles':
                label.textContent = 'Hit Double';
                target.textContent = `D${p.sequence[p.index].value}`;
                sub.textContent = `${p.index + 1} of 20`;
                break;
            case 'trebles':
                label.textContent = 'Hit Treble';
                target.textContent = `T${p.sequence[p.index].value}`;
                sub.textContent = `${p.index + 1} of 20`;
                break;
            case 'around':
                label.textContent = 'Hit Number';
                target.textContent = p.sequence[p.index].value;
                sub.textContent = `${p.index + 1} of 20`;
                break;
            case 'checkout':
                label.textContent = 'Remaining';
                target.textContent = p.remaining;
                sub.textContent = CHECKOUTS[p.remaining]?.primary || '';
                break;
            case 'random':
                label.textContent = 'Hit This';
                const prefix = p.target.mult === 3 ? 'T' : p.target.mult === 2 ? 'D' : '';
                target.textContent = prefix + p.target.value;
                sub.textContent = '';
                break;
            case 'bob27':
                label.textContent = `Double ${p.sequence[p.index].value}`;
                target.textContent = p.score;
                sub.textContent = `${3 - p.roundDarts} darts â€¢ ${p.index + 1}/20`;
                break;
        }
        
        // Update player panel stats
        p0.querySelector('.fs-player-score').textContent = p.mode === 'bob27' ? p.score : p.hits;
        const pct = p.darts > 0 ? Math.round(p.hits / p.darts * 100) : 0;
        p0.querySelector('.fs-player-meta').innerHTML = `
            <span>${pct}%</span>
            <span>Darts <span class="val">${p.darts}</span></span>
        `;
    }
    
    function handlePracticeFullscreenThrow(value, mult) {
        const p = app.practice;
        if (!p) return;
        
        const score = value * mult;
        p.darts++;
        haptic();
        
        switch (p.mode) {
            case 'doubles':
            case 'trebles':
            case 'around':
                const tgt = p.sequence[p.index];
                const neededMult = p.mode === 'around' ? 1 : tgt.mult;
                if (value === tgt.value && mult >= neededMult) {
                    p.hits++;
                    p.index++;
                    toast('HIT! âœ“', 'success');
                    if (p.index >= p.sequence.length) {
                        toast(`Complete! ${p.darts} darts`, 'success');
                        setTimeout(() => startPractice(p.mode), 1500);
                        return;
                    }
                }
                break;
                
            case 'checkout':
                p.remaining -= score;
                if (p.remaining === 0 && mult === 2) {
                    p.hits++;
                    toast('CHECKOUT! âœ“', 'success');
                    setRandomCheckout();
                } else if (p.remaining < 2 || p.remaining === 1) {
                    toast('Bust!', 'error');
                    setRandomCheckout();
                }
                break;
                
            case 'random':
                if (value === p.target.value && mult === p.target.mult) {
                    p.hits++;
                    toast('HIT! âœ“', 'success');
                    setRandomTarget();
                }
                break;
                
            case 'bob27':
                p.roundDarts++;
                const target = p.sequence[p.index];
                if (value === target.value && mult === 2) {
                    p.score += score;
                    p.roundHits++;
                    p.hits++;
                    toast(`+${score}`, 'success');
                }
                
                if (p.roundDarts >= 3) {
                    if (p.roundHits === 0) {
                        p.score -= target.value * 2;
                        toast(`-${target.value * 2}`, 'error');
                    }
                    p.roundDarts = 0;
                    p.roundHits = 0;
                    p.index++;
                    
                    if (p.score < 0) {
                        toast(`Game Over! Final: ${p.score}`, 'error');
                        setTimeout(() => startPractice(p.mode), 1500);
                        return;
                    }
                    if (p.index >= 20) {
                        toast(`Complete! Score: ${p.score}`, 'success');
                        setTimeout(() => startPractice(p.mode), 1500);
                        return;
                    }
                }
                break;
        }
        
        updatePracticeFullscreenUI();
    }

    function setRandomCheckout() {
        const checkoutScores = Object.keys(CHECKOUTS).map(Number).filter(n => n >= 40 && n <= 170);
        app.practice.target = checkoutScores[Math.floor(Math.random() * checkoutScores.length)];
        app.practice.remaining = app.practice.target;
    }

    function setRandomTarget() {
        const types = [1, 2, 3];
        const mult = types[Math.floor(Math.random() * 3)];
        const value = BOARD_ORDER[Math.floor(Math.random() * 20)];
        app.practice.target = { value, mult };
    }

    function updatePracticeUI() {
        const p = app.practice;
        const title = document.getElementById('practiceTitle');
        const label = document.getElementById('practiceLabel');
        const target = document.getElementById('practiceTarget');
        const sub = document.getElementById('practiceSub');
        
        switch (p.mode) {
            case 'doubles':
                title.textContent = 'DOUBLES PRACTICE';
                label.textContent = 'Hit This Double';
                target.textContent = `D${p.sequence[p.index].value}`;
                sub.textContent = `${p.index + 1} of 20`;
                break;
            case 'trebles':
                title.textContent = 'TREBLES PRACTICE';
                label.textContent = 'Hit This Treble';
                target.textContent = `T${p.sequence[p.index].value}`;
                sub.textContent = `${p.index + 1} of 20`;
                break;
            case 'around':
                title.textContent = 'AROUND THE CLOCK';
                label.textContent = 'Hit This Number';
                target.textContent = p.sequence[p.index].value;
                sub.textContent = `${p.index + 1} of 20`;
                break;
            case 'checkout':
                title.textContent = 'CHECKOUT PRACTICE';
                label.textContent = 'Remaining';
                target.textContent = p.remaining;
                sub.textContent = CHECKOUTS[p.remaining]?.primary || '';
                break;
            case 'random':
                title.textContent = 'RANDOM TARGET';
                label.textContent = 'Hit This';
                const prefix = p.target.mult === 3 ? 'T' : p.target.mult === 2 ? 'D' : '';
                target.textContent = prefix + p.target.value;
                sub.textContent = '';
                break;
            case 'bob27':
                title.textContent = "BOB'S 27";
                label.textContent = `Double ${p.sequence[p.index].value}`;
                target.textContent = p.score;
                sub.textContent = `${3 - p.roundDarts} darts left â€¢ ${p.index + 1}/20`;
                break;
        }
        
        document.getElementById('practiceHits').textContent = p.hits;
        document.getElementById('practiceDarts').textContent = p.darts;
        document.getElementById('practiceScore').textContent = 
            p.mode === 'bob27' ? p.score : 
            p.darts > 0 ? Math.round(p.hits / p.darts * 100) + '%' : '0%';
    }

    function handlePracticeThrow(seg) {
        const p = app.practice;
        if (!p) return;
        
        const value = +seg.dataset.value;
        const mult = +seg.dataset.mult;
        const score = value * mult;
        
        p.darts++;
        haptic();
        
        switch (p.mode) {
            case 'doubles':
            case 'trebles':
            case 'around':
                const tgt = p.sequence[p.index];
                const neededMult = p.mode === 'around' ? 1 : tgt.mult;
                if (value === tgt.value && mult >= neededMult) {
                    p.hits++;
                    p.index++;
                    toast('HIT! âœ“', 'success');
                    if (p.index >= p.sequence.length) {
                        toast(`Complete! ${p.darts} darts`, 'success');
                        resetPractice();
                        return;
                    }
                }
                break;
                
            case 'checkout':
                p.remaining -= score;
                if (p.remaining === 0 && mult === 2) {
                    p.hits++;
                    toast('CHECKOUT! âœ“', 'success');
                    setRandomCheckout();
                } else if (p.remaining < 2 || p.remaining === 1) {
                    toast('Bust!', 'error');
                    setRandomCheckout();
                }
                break;
                
            case 'random':
                if (value === p.target.value && mult === p.target.mult) {
                    p.hits++;
                    toast('HIT! âœ“', 'success');
                    setRandomTarget();
                }
                break;
                
            case 'bob27':
                p.roundDarts++;
                const target = p.sequence[p.index];
                if (value === target.value && mult === 2) {
                    p.score += score;
                    p.roundHits++;
                    p.hits++;
                    toast(`+${score}`, 'success');
                }
                
                if (p.roundDarts >= 3) {
                    if (p.roundHits === 0) {
                        p.score -= target.value * 2;
                        toast(`-${target.value * 2}`, 'error');
                    }
                    p.roundDarts = 0;
                    p.roundHits = 0;
                    p.index++;
                    
                    if (p.score < 0) {
                        toast(`Game Over! Final: ${p.score}`, 'error');
                        resetPractice();
                        return;
                    }
                    if (p.index >= 20) {
                        toast(`Complete! Score: ${p.score}`, 'success');
                        resetPractice();
                        return;
                    }
                }
                break;
        }
        
        updatePracticeUI();
    }

    function resetPractice() {
        if (app.practice) {
            startPractice(app.practice.mode);
        }
    }

    // ===== STATS =====
    function updateGlobalStats() {
        const s = app.stats;
        const avg = s.darts > 0 ? ((s.score / s.darts) * 3).toFixed(2) : '0.00';
        const first9Avg = s.first9Legs > 0 ? ((s.first9Total / (s.first9Legs * 9)) * 3).toFixed(2) : '0.00';
        const checkoutPct = s.checkoutAtt > 0 ? Math.round(s.checkoutHit / s.checkoutAtt * 100) : 0;
        
        document.getElementById('statAvg').textContent = avg;
        document.getElementById('statFirst9').textContent = first9Avg;
        document.getElementById('statCheckout').textContent = checkoutPct + '%';
        document.getElementById('statGames').textContent = s.games;
        document.getElementById('statWins').textContent = s.wins;
        document.getElementById('stat180s').textContent = s.one80s;
        document.getElementById('statHighCo').textContent = s.highCo;
        document.getElementById('statTons').textContent = s.tons + s.ton40s + s.one80s;
        document.getElementById('statDarts').textContent = s.darts;
    }

    // ===== UTILS =====
    function toast(msg, type = '') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = `toast ${type} show`;
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    function haptic() {
        if (app.settings.haptic && navigator.vibrate) {
            navigator.vibrate(15);
        }
    }

    // ===== EVENTS =====
    function bindEvents() {
        // Nav
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => navigate(btn.dataset.nav));
        });
        
        // Home cards
        document.querySelectorAll('.home-card').forEach(card => {
            card.addEventListener('click', () => {
                const action = card.dataset.action;
                if (action === 'quick-game') {
                    app.setup.players = ['Player 1', 'Player 2'];
                    app.setup.type = 501;
                    app.setup.legs = 1;
                    app.setup.sets = 1;
                    startGame();
                } else if (action === 'new-game') navigate('play');
                else if (action === 'practice') navigate('practice');
                else if (action === 'checkouts') navigate('learn');
                else if (action === 'stats') { updateGlobalStats(); navigate('stats'); }
            });
        });
        
        // Setup options
        ['gameTypeOpts', 'outModeOpts', 'legsOpts', 'setsOpts', 'firstThrowOpts'].forEach(id => {
            document.getElementById(id)?.addEventListener('click', e => {
                if (e.target.classList.contains('option-btn')) {
                    e.currentTarget.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    e.target.classList.add('selected');
                    const val = e.target.dataset.val;
                    if (id === 'gameTypeOpts') app.setup.type = +val;
                    else if (id === 'outModeOpts') app.setup.out = val;
                    else if (id === 'legsOpts') app.setup.legs = +val;
                    else if (id === 'setsOpts') app.setup.sets = +val;
                    else if (id === 'firstThrowOpts') app.setup.firstThrow = val;
                    saveData(); // Persist setup changes
                }
            });
        });
        
        // Add player
        document.getElementById('addPlayerBtn').addEventListener('click', () => {
            if (app.setup.players.length < 8) {
                app.setup.players.push(`Player ${app.setup.players.length + 1}`);
                renderPlayers();
                saveData();
            }
        });
        
        // Start game
        document.getElementById('startGameBtn').addEventListener('click', startGame);
        
        // Input tabs - sync with fullscreen
        document.querySelectorAll('.input-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const mode = tab.dataset.tab;
                document.querySelectorAll('.input-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.input-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`panel-${mode}`).classList.add('active');
                
                // Sync to fullscreen if open
                if (app.fullscreen) {
                    app.fsInputMode = mode;
                    document.querySelectorAll('.fs-input-tab').forEach(t => 
                        t.classList.toggle('active', t.dataset.fstab === mode));
                    document.querySelectorAll('.fs-input-panel').forEach(p => 
                        p.classList.toggle('active', p.id === `fs-panel-${mode}`));
                }
            });
        });
        
        // Multiplier - sync with fullscreen
        document.querySelectorAll('.mult-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mult-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                app.multiplier = +btn.dataset.mult;
                
                // Sync to fullscreen
                app.fsMultiplier = app.multiplier;
                document.querySelectorAll('.fs-mult-btn').forEach(b => 
                    b.classList.toggle('active', +b.dataset.fsmult === app.fsMultiplier));
            });
        });
        
        // Darts grid - records individual darts
        document.getElementById('dartsGrid').addEventListener('click', e => {
            if (e.target.classList.contains('dart-btn') && app.game) {
                // Check if turn is already complete
                if (app.game.throws.length >= 3) {
                    toast('Turn complete - tap Next', 'error');
                    return;
                }
                if (app.game.throws.length > 0 && app.game.throws[0].isTurnTotal) {
                    toast('Turn complete - tap Next', 'error');
                    return;
                }
                
                const num = +e.target.dataset.num;
                let mult = app.multiplier;
                let value = num;
                
                if (num === 50) { value = 25; mult = 2; }
                else if (num === 25) { mult = Math.min(mult, 2); }
                else if (num === 0) { mult = 1; }
                
                recordThrow(value, mult, value * mult);
            }
        });
        
        // Quick grid - records turn total (3 darts at once)
        document.getElementById('quickGrid').addEventListener('click', e => {
            if (e.target.classList.contains('quick-btn') && app.game) {
                const score = +e.target.dataset.score;
                recordTurn(score);
            }
        });
        
        // Numpad - records turn total (3 darts at once)
        document.getElementById('numpadGrid').addEventListener('click', e => {
            if (e.target.classList.contains('num-btn')) {
                const key = e.target.dataset.key;
                const display = document.getElementById('numpadDisplay');
                
                if (key === 'clear') {
                    app.numpadVal = '';
                    display.textContent = '-';
                } else if (key === 'enter') {
                    if (app.numpadVal && app.game) {
                        const score = +app.numpadVal;
                        recordTurn(score);
                        app.numpadVal = '';
                        display.textContent = '-';
                    }
                } else {
                    if (app.numpadVal.length < 3) {
                        app.numpadVal += key;
                        display.textContent = app.numpadVal;
                        
                        // Show warning if impossible score
                        const currentVal = +app.numpadVal;
                        if (currentVal > 180) {
                            display.style.color = '#e63946';
                        } else if (IMPOSSIBLE_SCORES.includes(currentVal)) {
                            display.style.color = '#f4a261';
                        } else {
                            display.style.color = '';
                        }
                    }
                }
            }
        });
        
        // Game actions
        document.getElementById('undoBtn').addEventListener('click', undoThrow);
        document.getElementById('missBtn').addEventListener('click', () => {
            if (app.game) {
                // Check if turn is already complete
                if (app.game.throws.length >= 3) {
                    toast('Turn complete - tap Next', 'error');
                    return;
                }
                if (app.game.throws.length > 0 && app.game.throws[0].isTurnTotal) {
                    toast('Turn complete - tap Next', 'error');
                    return;
                }
                recordThrow(0, 1, 0);
            }
        });
        document.getElementById('nextBtn').addEventListener('click', () => {
            if (app.game) nextPlayer();
        });
        
        // Fullscreen buttons
        document.getElementById('fullscreenBtn').addEventListener('click', openFullscreen);
        document.getElementById('fullscreenBtnBar').addEventListener('click', openFullscreen);
        document.getElementById('fsClose').addEventListener('click', () => {
            const overlay = document.getElementById('fullscreenOverlay');
            if (overlay.classList.contains('practice-mode')) {
                closePracticeFullscreen();
            } else {
                closeFullscreen();
            }
        });
        document.getElementById('fsUndo').addEventListener('click', undoThrow);
        document.getElementById('fsMiss').addEventListener('click', () => {
            if (app.practice) {
                handlePracticeFullscreenThrow(0, 1);
            } else if (app.game) {
                if (app.game.throws.length >= 3 || (app.game.throws.length > 0 && app.game.throws[0].isTurnTotal)) {
                    toast('Turn complete - tap Next', 'error');
                    return;
                }
                recordThrow(0, 1, 0);
            }
        });
        document.getElementById('fsNext').addEventListener('click', () => {
            if (app.game) nextPlayer();
        });
        
        // Practice fullscreen buttons
        document.getElementById('fsPracticeExit').addEventListener('click', closePracticeFullscreen);
        document.getElementById('fsPracticeReset').addEventListener('click', () => {
            if (app.practice) {
                startPractice(app.practice.mode);
            }
        });

        // Fullscreen input tabs
        document.querySelectorAll('.fs-input-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                app.fsInputMode = tab.dataset.fstab;
                document.querySelectorAll('.fs-input-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.fs-input-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`fs-panel-${app.fsInputMode}`).classList.add('active');
                
                // Sync to regular input tabs
                document.querySelectorAll('.input-tab').forEach(t => 
                    t.classList.toggle('active', t.dataset.tab === app.fsInputMode));
                document.querySelectorAll('.input-panel').forEach(p => 
                    p.classList.toggle('active', p.id === `panel-${app.fsInputMode}`));
            });
        });

        // Fullscreen multiplier buttons
        document.querySelectorAll('.fs-mult-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                app.fsMultiplier = +btn.dataset.fsmult;
                document.querySelectorAll('.fs-mult-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Sync to regular multiplier
                app.multiplier = app.fsMultiplier;
                document.querySelectorAll('.mult-btn').forEach(b => 
                    b.classList.toggle('active', +b.dataset.mult === app.multiplier));
            });
        });

        // Fullscreen darts grid
        document.getElementById('fsDartsGrid').addEventListener('click', e => {
            if (!e.target.classList.contains('fs-dart-btn')) return;
            
            const num = +e.target.dataset.num;
            let mult = app.fsMultiplier;
            let value = num;
            
            if (num === 50) { value = 25; mult = 2; }
            else if (num === 25) { mult = Math.min(mult, 2); }
            else if (num === 0) { value = 0; mult = 1; }
            
            if (app.practice) {
                handlePracticeFullscreenThrow(value, mult);
            } else if (app.game) {
                if (app.game.throws.length >= 3 || (app.game.throws.length > 0 && app.game.throws[0].isTurnTotal)) {
                    toast('Turn complete - tap Next', 'error');
                    return;
                }
                recordThrow(value, mult, value * mult);
            }
        });

        // Fullscreen quick grid
        document.getElementById('fsQuickGrid').addEventListener('click', e => {
            if (e.target.classList.contains('fs-quick-btn') && app.game) {
                const score = +e.target.dataset.score;
                recordTurn(score);
            }
        });

        // Fullscreen numpad
        document.getElementById('fsNumpadGrid').addEventListener('click', e => {
            if (e.target.classList.contains('fs-num-btn')) {
                const key = e.target.dataset.key;
                const display = document.getElementById('fsNumpadDisplay');
                
                if (key === 'clear') {
                    app.fsNumpadVal = '';
                    display.textContent = '-';
                    display.style.color = '';
                } else if (key === 'enter') {
                    if (app.fsNumpadVal && app.game) {
                        const score = +app.fsNumpadVal;
                        recordTurn(score);
                        app.fsNumpadVal = '';
                        display.textContent = '-';
                        display.style.color = '';
                    }
                } else {
                    if (app.fsNumpadVal.length < 3) {
                        app.fsNumpadVal += key;
                        display.textContent = app.fsNumpadVal;
                        
                        const currentVal = +app.fsNumpadVal;
                        if (currentVal > 180) {
                            display.style.color = '#e63946';
                        } else if (IMPOSSIBLE_SCORES.includes(currentVal)) {
                            display.style.color = '#f4a261';
                        } else {
                            display.style.color = '';
                        }
                    }
                }
            }
        });
        
        // Practice
        document.querySelectorAll('.practice-card').forEach(card => {
            console.log('Binding click to practice card:', card.dataset.practice);
            card.addEventListener('click', () => {
                console.log('Practice card clicked:', card.dataset.practice);
                startPractice(card.dataset.practice);
            });
        });
        
        document.getElementById('practiceExitBtn').addEventListener('click', () => {
            app.practice = null;
            navigate('practice');
        });
        document.getElementById('practiceResetBtn').addEventListener('click', resetPractice);
        
        // Settings
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.add('open');
        });
        document.getElementById('statsBtn').addEventListener('click', () => {
            updateGlobalStats();
            navigate('stats');
        });
        
        document.querySelectorAll('[data-close]').forEach(el => {
            el.addEventListener('click', () => {
                document.getElementById(`${el.dataset.close}Modal`).classList.remove('open');
            });
        });
        
        document.querySelectorAll('[data-theme]').forEach(btn => {
            btn.addEventListener('click', () => {
                app.settings.theme = btn.dataset.theme;
                applySettings();
                saveData();
            });
        });
        
        document.querySelectorAll('[data-color]').forEach(btn => {
            btn.addEventListener('click', () => {
                app.settings.color = btn.dataset.color;
                applySettings();
                saveData();
            });
        });
        
        // Custom color pickers
        const customPrimaryPicker = document.getElementById('customPrimary');
        const customSecondaryPicker = document.getElementById('customSecondary');
        
        if (customPrimaryPicker) {
            customPrimaryPicker.addEventListener('input', (e) => {
                app.settings.customPrimary = e.target.value;
                applySettings();
            });
            customPrimaryPicker.addEventListener('change', () => {
                saveData();
            });
        }
        
        if (customSecondaryPicker) {
            customSecondaryPicker.addEventListener('input', (e) => {
                app.settings.customSecondary = e.target.value;
                applySettings();
            });
            customSecondaryPicker.addEventListener('change', () => {
                saveData();
            });
        }
        
        document.querySelectorAll('[data-sound]').forEach(btn => {
            btn.addEventListener('click', () => {
                app.settings.sound = btn.dataset.sound === 'on';
                applySettings();
                saveData();
            });
        });
        
        document.querySelectorAll('[data-haptic]').forEach(btn => {
            btn.addEventListener('click', () => {
                app.settings.haptic = btn.dataset.haptic === 'on';
                applySettings();
                saveData();
            });
        });
        
        document.querySelectorAll('[data-checkout]').forEach(btn => {
            btn.addEventListener('click', () => {
                app.settings.checkoutPref = btn.dataset.checkout;
                applySettings();
                saveData();
                // Update checkout hint if in game
                if (app.game) {
                    app.turnCheckout = null; // Reset to recalculate with new pref
                    updateCheckoutHint();
                }
            });
        });

        document.querySelectorAll('[data-autofs]').forEach(btn => {
            btn.addEventListener('click', () => {
                app.settings.autoFullscreen = btn.dataset.autofs === 'on';
                applySettings();
                saveData();
            });
        });
        
        // Game over
        document.querySelectorAll('.game-over-actions button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('gameOverModal').classList.remove('open');
                if (btn.dataset.action === 'rematch') startGame();
                else navigate('home');
            });
        });

        // Coin toss
        document.getElementById('coinHeadsBtn').addEventListener('click', () => flipCoin('heads'));
        document.getElementById('coinTailsBtn').addEventListener('click', () => flipCoin('tails'));
        document.getElementById('coinStartBtn').addEventListener('click', closeCoinToss);

        // Nearest bull
        document.getElementById('bullStartBtn').addEventListener('click', closeNearestBull);
    }

    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
